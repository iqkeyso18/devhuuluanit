<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Quản Lý Trung Tâm Toán Cô Huyền</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sử dụng font Inter hiện đại */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Nền trắng xanh nhạt hiện đại */
        }
        
        .main-content-area {
            min-height: calc(100vh - 80px);
        }
        
        /* 1. Thiết kế Card Cao Cấp (Premium Card Style) */
        .card-premium {
            border-radius: 1.5rem; /* rounded-3xl */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            border: 1px solid #f3f4f6;
        }
        .card-premium:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -8px rgba(0, 0, 0, 0.1), 0 10px 15px -7px rgba(0, 0, 0, 0.08);
        }

        /* 2. Style cho nút Navigation Active */
        .nav-btn.active {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 10px -1px rgba(79, 70, 229, 0.5);
            transform: scale(1.02);
        }

        /* 3. Style tập trung cho Input/Select (Focus Ring) */
        .form-input-style {
            transition: all 0.2s ease;
        }
        .form-input-style:focus {
            outline: 2px solid transparent; /* Loại bỏ outline mặc định */
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.4); /* ring indigo-500/40 */
            border-color: #6366f1;
        }
        
        /* 4. Custom scrollbar cho table */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
    </style>
    
    <script>
        // --- CÁC HẰNG SỐ CẦN THIẾT ---
        const ADMIN_PASSWORD = "admin"; // Mật khẩu admin đơn giản (CHỈ DÙNG CHO DEMO)
        
        const CLASS_RATES = {
            '4.1': 80000, '4.2': 80000, '4.3': 80000,
            '5.1': 80000, '5.2': 80000, '5.3': 80000,
            '6.1': 80000, '6.2': 80000, '6.3': 80000,
            '7.1': 80000, '7.2': 80000, '7.3': 80000,
            '8.1': 80000, '8.2': 80000, '8.3': 80000,
            '9.1': 80000, '9.2': 80000, '9.3': 80000,
            '1-1': 200000 // Lớp kèm 1-1
        };
        const CLASS_OPTIONS = Object.keys(CLASS_RATES);
        
        const STORAGE_KEYS = {
            students: 'huyenMathCenter_students',
            attendance: 'huyenMathCenter_attendance'
        };
        // NEW: HẰNG SỐ VÀ HÀM TIỆN ÍCH CHO NHẬN XÉT
        const REVIEW_ATTITUDE_OPTIONS = ['Tốt', 'Không tốt'];
        const REVIEW_HW_STATUS_OPTIONS = ['Đạt', 'Không đạt'];
        const MAX_SESSIONS = 10;
        
        // --- CẬP NHẬT CẤU TRÚC DỮ LIỆU SESSION (BUỔI HỌC) ---
        /** Tạo đối tượng session rỗng cho một buổi học */
        const createDefaultSession = () => ({
            isPresent: false, // Trạng thái điểm danh
            date: ''          // Ngày diễn ra buổi học (YYYY-MM-DD)
        });

        /** Tạo đối tượng nhận xét rỗng cho một buổi học */
        const createDefaultReview = () => ({
            attitude: REVIEW_ATTITUDE_OPTIONS[0], // Mặc định là Tốt
            homeworkStatus: REVIEW_HW_STATUS_OPTIONS[0], // Mặc định là Đạt
            homeworkScore: '',
            homeworkNote: '',
            oldLessonScore: '',
            oldLessonNote: '',
            testScore: '',
            testNote: '',
            averageScore: ''
        });
        
        // --- BIẾN STATE TOÀN CỤC CỦA ỨNG DỤNG ---
        let students = [];
        let attendanceRecords = [];
        let currentView = 'dashboard';
        let loggedIn = false;
        let currentMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
        
        // --- HÀM QUẢN LÝ LOCALSTORAGE (LƯU VÀ TẢI DỮ LIỆU) ---

        /** Tải dữ liệu từ localStorage */
        const loadData = (type) => {
            const json = localStorage.getItem(STORAGE_KEYS[type]);
            try {
                // Tải dữ liệu. Xử lý migration nếu cần (ví dụ: attendanceRecords cũ chưa có cấu trúc session/review mới)
                const data = json ? JSON.parse(json) : [];
                if (type === 'attendance') {
                    // Cập nhật cấu trúc cũ sang cấu trúc mới (Migration)
                    return data.map(record => {
                        let newSessions = {};
                        if (record.sessions) {
                            for (let i = 1; i <= MAX_SESSIONS; i++) {
                                const key = i.toString();
                                // Nếu dữ liệu cũ là boolean, chuyển sang object mới
                                if (typeof record.sessions[key] === 'boolean') {
                                    newSessions[key] = { isPresent: record.sessions[key], date: '' };
                                } else if (typeof record.sessions[key] === 'object' && record.sessions[key] !== null) {
                                    // Giữ nguyên object nếu đã đúng định dạng (có thể thiếu date/isPresent, sẽ thêm default)
                                    newSessions[key] = Object.assign({}, createDefaultSession(), record.sessions[key]);
                                } else {
                                    newSessions[key] = createDefaultSession();
                                }
                            }
                        } else {
                            for (let i = 1; i <= MAX_SESSIONS; i++) {
                                newSessions[i.toString()] = createDefaultSession();
                            }
                        }
                        record.sessions = newSessions;
                        
                        // Đảm bảo sessionReviews tồn tại và đúng cấu trúc
                        if (!record.sessionReviews) {
                            record.sessionReviews = {};
                            for (let i = 1; i <= MAX_SESSIONS; i++) {
                                record.sessionReviews[i.toString()] = createDefaultReview();
                            }
                        } else {
                             for (let i = 1; i <= MAX_SESSIONS; i++) {
                                record.sessionReviews[i.toString()] = Object.assign({}, createDefaultReview(), record.sessionReviews[i.toString()]);
                            }
                        }
                        return record;
                    });
                }
                return data;
            } catch (e) {
                console.error(`Lỗi khi tải dữ liệu ${type} từ localStorage:`, e);
                return [];
            }
        };
        
        /** Lưu dữ liệu vào localStorage và tự động render lại UI */
        const saveData = (type, data) => {
            localStorage.setItem(STORAGE_KEYS[type], JSON.stringify(data));
            // Cập nhật state cục bộ
            if (type === 'students') students = data;
            if (type === 'attendance') attendanceRecords = data;
            
            // Giả lập cập nhật real-time bằng cách render lại các view
            if (loggedIn) {
                if (currentView === 'students') renderStudentList();
                if (currentView === 'attendance') renderAttendanceView();
                if (currentView === 'tuition') renderTuitionTable();
                if (currentView === 'reviews') renderReviewView();
                if (currentView === 'dashboard') renderIncomeDashboard();
            }
        };

        /** Tải dữ liệu ban đầu khi ứng dụng khởi động */
        const loadInitialData = () => {
            students = loadData('students');
            attendanceRecords = loadData('attendance');
        };

        // --- HÀM TIỆN ÍCH ---
        const formatCurrency = (amount) => {
            // Sử dụng Intl.NumberFormat để hiển thị VND đẹp mắt
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        };
        
        // --- HÀM QUẢN LÝ TÀI KHOẢN (CLIENT-SIDE FAKE ADMIN) ---
        window.handleLogin = () => {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                loggedIn = true;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('header-status').textContent = 'Đã đăng nhập (Admin)';
                loadInitialData(); // Tải dữ liệu ngay sau khi đăng nhập
                switchView(currentView); // Hiển thị dashboard
            } else {
                showModal('Lỗi Đăng Nhập', 'Mật khẩu quản trị không đúng. Vui lòng thử lại.');
            }
            document.getElementById('admin-password').value = ''; // Xóa mật khẩu
        };
        
        window.handleLogout = () => {
             showModal('Xác Nhận Đăng Xuất', 'Bạn có chắc chắn muốn đăng xuất khỏi hệ thống?', () => {
                loggedIn = false;
                currentView = 'dashboard';
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('header-status').textContent = 'Chưa đăng nhập';
                document.getElementById('nav-bar').querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
             });
        }

        // --- CHUYỂN ĐỔI VIEW ---
        window.switchView = (viewId) => {
            if (!loggedIn) return;
            currentView = viewId;
            document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            
            // Xử lý Active state trên thanh Nav
            document.querySelectorAll('#nav-bar button').forEach(el => 
                el.classList.remove('active'));
            document.querySelector(`button[onclick="switchView('${viewId}')"]`).classList.add('active');

            // Render lại nội dung cụ thể
            if (viewId === 'students') renderStudentList();
            if (viewId === 'attendance') renderAttendanceView();
            if (viewId === 'tuition') renderTuitionTable();
            if (viewId === 'reviews') renderReviewView();
            if (viewId === 'dashboard') renderIncomeDashboard();
        };

        // --- MODULE QUẢN LÝ HỌC SINH (GIỮ NGUYÊN) ---
        window.handleAddStudent = (event) => {
            event.preventDefault();
            const nameInput = document.getElementById('new-student-name');
            const classSelect = document.getElementById('new-student-class');
            const name = nameInput.value.trim();
            const classId = classSelect.value;
            const tuitionRate = CLASS_RATES[classId];
            if (!name || !classId) {
                showModal('Lỗi', 'Vui lòng nhập tên và chọn lớp học.');
                return;
            }

            try {
                const newStudent = {
                    id: crypto.randomUUID(),
                    name,
                    classId,
                    tuitionRate,
                    createdAt: new Date().toISOString()
                };
                students.push(newStudent);
                saveData('students', students);
                
                showModal('Thành Công', `Đã thêm học sinh ${name} vào lớp ${classId}.`);
                nameInput.value = '';
                classSelect.value = CLASS_OPTIONS[0];
            } catch (e) {
                console.error("Lỗi khi thêm học sinh:", e);
                showModal('Lỗi', 'Không thể thêm học sinh. Vui lòng thử lại.');
            }
        };
        
        window.handleEditStudent = (id, currentName, currentClass) => {
            // Mở modal chỉnh sửa
            document.getElementById('edit-student-id').value = id;
            document.getElementById('edit-student-name').value = currentName;
            document.getElementById('edit-student-class').innerHTML = CLASS_OPTIONS.map(c => 
                `<option value="${c}" ${c === currentClass ? 'selected' : ''}>${c}</option>`
            ).join('');
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.submitEditStudent = () => {
            const id = document.getElementById('edit-student-id').value;
            const newName = document.getElementById('edit-student-name').value.trim();
            const newClassId = document.getElementById('edit-student-class').value;
            const newRate = CLASS_RATES[newClassId];
            if (!newName || !newClassId) {
                showModal('Lỗi', 'Tên và Lớp không được để trống.');
                return;
            }

            try {
                const index = students.findIndex(s => s.id === id);
                if (index !== -1) {
                    students[index] = { ...students[index], name: newName, classId: newClassId, tuitionRate: newRate };
                    saveData('students', students);
                    document.getElementById('edit-modal').classList.add('hidden');
                    showModal('Thành Công', `Đã cập nhật thông tin học sinh ${newName}.`);
                }
            } catch (e) {
                console.error("Lỗi khi sửa học sinh:", e);
                showModal('Lỗi', 'Không thể cập nhật học sinh. Vui lòng thử lại.');
            }
        };
        
        window.handleDeleteStudent = (id, name) => {
            showModal('Xác Nhận Xóa', `Bạn có chắc chắn muốn xóa học sinh ${name}? Hành động này không thể hoàn tác và sẽ xóa tất cả bản ghi điểm danh liên quan.`, () => {
                try {
                    students = students.filter(s => s.id !== id);
                    saveData('students', students);
                    
                    // Xóa các bản ghi điểm danh liên quan
                    attendanceRecords = attendanceRecords.filter(r => r.studentId !== id);
                    saveData('attendance', attendanceRecords);
                    
                    showModal('Thành Công', `Đã xóa học sinh ${name}.`);
                } catch (e) {
                    console.error("Lỗi khi xóa học sinh:", e);
                    showModal('Lỗi', 'Không thể xóa học sinh. Vui lòng thử lại.');
                }
            }, true); // Cờ xác nhận nguy hiểm
        };
        
        const renderStudentList = () => {
            const container = document.getElementById('student-list-container');
            const filterClass = document.getElementById('student-filter-class').value;
            const searchName = document.getElementById('student-search-name').value.toLowerCase();

            let filteredStudents = students.slice(); // Copy array
            if (filterClass !== 'all') {
                filteredStudents = filteredStudents.filter(s => s.classId === filterClass);
            }
            if (searchName) {
                filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchName));
            }
            // Sắp xếp theo tên
            filteredStudents.sort((a, b) => a.name.localeCompare(b.name, 'vi', { sensitivity: 'base' }));
            
            if (filteredStudents.length === 0) {
                container.innerHTML = `<p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Không tìm thấy học sinh nào phù hợp với điều kiện lọc.</p>`;
                return;
            }
            
            const monthDisplay = `${currentMonth.substring(5, 7)}/${currentMonth.substring(0, 4)}`;
            const rows = filteredStudents.map(s => {
                // Lấy trạng thái học phí của tháng hiện tại
                const currentMonthRecord = getAttendanceRecord(s.id, currentMonth);
                const isPaid = currentMonthRecord ? currentMonthRecord.isPaid : false;

                const tuitionStatusBadge = isPaid 
                    ? `<span class="inline-block px-3 py-1 text-xs font-bold rounded-full bg-green-100 text-green-700">Đã nộp (${monthDisplay})</span>`
                    : `<span class="inline-block px-3 py-1 text-xs font-bold rounded-full bg-red-100 text-red-700">Chưa nộp (${monthDisplay})</span>`;
                    
                return `
                    <tr class="border-b last:border-b-0 hover:bg-indigo-50 transition duration-150">
                        <td class="p-4 text-sm font-semibold text-gray-800">${s.name}</td>
                        <td class="p-4 text-sm text-center">
                            <span class="inline-block px-3 py-1 text-xs font-bold rounded-full bg-indigo-100 text-indigo-700">${s.classId}</span>
                        </td>
                        <td class="p-4 text-sm text-right font-medium text-green-600">${formatCurrency(s.tuitionRate)}</td>
                        <td class="p-4 text-sm text-center">${tuitionStatusBadge}</td> 
                        <td class="p-4 text-sm text-center space-x-2">
                            <button onclick="handleEditStudent('${s.id}', '${s.name.replace(/'/g, "\\'")}', '${s.classId}')" 
                                title="Chỉnh sửa"
                                class="text-indigo-600 hover:text-indigo-800 transition duration-150 p-2 rounded-full hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button onclick="handleDeleteStudent('${s.id}', '${s.name.replace(/'/g, "\\'")}')" 
                                title="Xóa"
                                class="text-red-600 hover:text-red-800 transition duration-150 p-2 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" 
                                viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="overflow-x-auto rounded-2xl shadow-lg border border-gray-100 mt-6 custom-scrollbar">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th scope="col" class="px-4 py-4 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">Tên Học Sinh</th>
                                <th scope="col" class="px-4 py-4 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider">Lớp</th>
                                <th scope="col" class="px-4 py-4 text-right text-xs font-bold text-indigo-700 uppercase tracking-wider">Học Phí/Buổi</th>
                                <th scope="col" class="px-4 py-4 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider">Trạng Thái HP</th> 
                                <th scope="col" class="px-4 py-4 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">${rows}</tbody>
                    </table>
                </div>
            `;
        };
        window.renderStudentList = renderStudentList;

        // --- MODULE ĐIỂM DANH & HỌC PHÍ ---
        
        // Lấy bản ghi điểm danh (Attendance Record) theo studentId và monthYear
        const getAttendanceRecord = (studentId, monthYear) => {
            return attendanceRecords.find(r => r.studentId === studentId && r.monthYear === monthYear);
        };

        /** HÀM MỚI: Cập nhật ngày học cho một buổi */
        window.updateSessionDate = (studentId, sessionNum, dateEl) => {
            const currentBlockId = document.getElementById('attendance-month-selector').value;
            const recordId = `${studentId}-${currentBlockId}`;
            let record = getAttendanceRecord(studentId, currentBlockId);
            const sessionNumStr = sessionNum.toString();
            const newDate = dateEl.value;

            // Hàm tạo/cập nhật record chung
            const createOrUpdateRecord = (rec) => {
                if (!rec) {
                    const student = students.find(s => s.id === studentId);
                    if (!student) return null;

                    let sessions = {};
                    let sessionReviews = {};
                    for(let i=1; i<=MAX_SESSIONS; i++) {
                        sessions[i.toString()] = createDefaultSession(); 
                        sessionReviews[i.toString()] = createDefaultReview(); 
                    }
                    sessions[sessionNumStr].date = newDate; 

                    rec = {
                        id: recordId,
                        studentId: studentId,
                        classId: student.classId,
                        monthYear: currentBlockId,
                        sessions: sessions,
                        isPaid: false, 
                        note: '', 
                        sessionReviews: sessionReviews 
                    };
                    attendanceRecords.push(rec); 
                } else {
                    if (!rec.sessions[sessionNumStr]) {
                        rec.sessions[sessionNumStr] = createDefaultSession();
                    }
                    rec.sessions[sessionNumStr].date = newDate;
                    attendanceRecords = attendanceRecords.map(r => r.id === recordId ? rec : r);
                }
                return rec;
            };

            createOrUpdateRecord(record);
            saveData('attendance', attendanceRecords);
        };


        // CẬP NHẬT: Refactor updateAttendance để dùng cấu trúc mới
        window.updateAttendance = (studentId, sessionNum) => {
            const currentBlockId = document.getElementById('attendance-month-selector').value; // monthYear acts as blockId
            const recordId = `${studentId}-${currentBlockId}`;
            let record = getAttendanceRecord(studentId, currentBlockId);
            const sessionNumStr = sessionNum.toString();

            if (record) {
                // Đảm bảo session object tồn tại
                if (!record.sessions[sessionNumStr]) {
                    record.sessions[sessionNumStr] = createDefaultSession();
                }
                
                // Cập nhật trạng thái điểm danh
                const currentState = record.sessions[sessionNumStr].isPresent;
                record.sessions[sessionNumStr].isPresent = !currentState;
                
                // Cập nhật lại array
                attendanceRecords = attendanceRecords.map(r => r.id === recordId ? record : r);
            } else {
                // Tạo mới bản ghi
                const student = students.find(s => s.id === studentId);
                if (!student) {
                    showModal('Lỗi', 'Không tìm thấy thông tin học sinh.');
                    return;
                }
                
                // Khởi tạo 10 buổi, set buổi hiện tại là true
                let sessions = {};
                let sessionReviews = {}; 
                for(let i=1; i<=MAX_SESSIONS; i++) {
                    sessions[i.toString()] = createDefaultSession(); 
                    sessionReviews[i.toString()] = createDefaultReview(); 
                }
                sessions[sessionNumStr].isPresent = true; 
                
                record = {
                    id: recordId,
                    studentId: studentId,
                    classId: student.classId,
                    monthYear: currentBlockId,
                    sessions: sessions,
                    isPaid: false, 
                    note: '', 
                    sessionReviews: sessionReviews 
                };
                attendanceRecords.push(record);
            }
            
            saveData('attendance', attendanceRecords);
        };


        /** HÀM MỚI: Cập nhật trạng thái thanh toán học phí */
        window.handleTuitionPayment = (studentId, monthYear) => {
            const recordId = `${studentId}-${monthYear}`;
            let record = getAttendanceRecord(studentId, monthYear);

            if (!record) {
                // Nếu chưa có bản ghi điểm danh (chưa đi học buổi nào), tạo bản ghi mới để lưu trạng thái paid
                const student = students.find(s => s.id === studentId);
                if (!student) {
                    showModal('Lỗi', 'Không tìm thấy thông tin học sinh.');
                    return;
                }
                
                let sessions = {};
                for(let i=1; i<=MAX_SESSIONS; i++) {
                    sessions[i.toString()] = createDefaultSession();
                }
                
                let sessionReviews = {};
                for(let i=1; i<=MAX_SESSIONS; i++) {
                    sessionReviews[i.toString()] = createDefaultReview();
                }

                record = {
                    id: recordId,
                    studentId: studentId,
                    classId: student.classId,
                    monthYear: monthYear,
                    sessions: sessions, // Sử dụng sessions mới
                    isPaid: true, // Set thành Đã nộp
                    note: '', 
                    sessionReviews: sessionReviews 
                };
                attendanceRecords.push(record);
            } else {
                // Đảo ngược trạng thái
                record.isPaid = !record.isPaid;
                attendanceRecords = attendanceRecords.map(r => r.id === recordId ? record : r);
            }
            
            saveData('attendance', attendanceRecords);
            // Cần cập nhật lại các view liên quan
            if (currentView === 'students') renderStudentList();
            if (currentView === 'tuition') renderTuitionTable();
        };

        /** HÀM MỚI: Cập nhật ghi chú học phí (dùng chung cho cả Điểm Danh và Học Phí) */
        window.handleUpdateTuitionNote = (studentId, monthYear, textareaEl) => {
            const newNote = textareaEl.value.trim();
            const recordId = `${studentId}-${monthYear}`;
            let record = getAttendanceRecord(studentId, monthYear);

            if (!record) {
                // Nếu chưa có bản ghi (chưa điểm danh/chưa nộp), tạo bản ghi mới với note
                const student = students.find(s => s.id === studentId);
                if (!student) return;
                
                let sessions = {};
                for(let i=1; i<=MAX_SESSIONS; i++) {
                    sessions[i.toString()] = createDefaultSession();
                }
                
                let sessionReviews = {}; 
                for(let i=1; i<=MAX_SESSIONS; i++) {
                    sessionReviews[i.toString()] = createDefaultReview();
                }

                record = {
                    id: recordId,
                    studentId: studentId,
                    classId: student.classId,
                    monthYear: monthYear,
                    sessions: sessions, 
                    isPaid: false, 
                    note: newNote, // Lưu ghi chú
                    sessionReviews: sessionReviews 
                };
                // Chỉ thêm bản ghi nếu có ghi chú để tránh rác dữ liệu
                if(newNote) attendanceRecords.push(record);
            } else {
                // Cập nhật note cho bản ghi đã tồn tại
                record.note = newNote;
                attendanceRecords = attendanceRecords.map(r => r.id === recordId ? record : r);
                // Nếu người dùng xóa hết note, và record không có buổi điểm danh, và chưa thanh toán -> xóa luôn record để dọn dẹp
                const hasSessions = Object.keys(record.sessions).length > 0 && Object.values(record.sessions).some(s => s.isPresent === true || s.date !== '');
                const hasReviews = record.sessionReviews && Object.values(record.sessionReviews).some(r => Object.values(r).some(v => v !== '' && v !== REVIEW_ATTITUDE_OPTIONS[0] && v !== REVIEW_HW_STATUS_OPTIONS[0]));
                
                if (newNote === '' && !hasSessions && !record.isPaid && !hasReviews) {
                    attendanceRecords = attendanceRecords.filter(r => r.id !== recordId);
                }
            }
            
            saveData('attendance', attendanceRecords);
            // Không cần render lại toàn bộ, chỉ cần lưu dữ liệu
        };
        
        const renderAttendanceView = () => {
            const container = document.getElementById('attendance-table-container');
            const filterClass = document.getElementById('attendance-filter-class').value;
            const monthYear = document.getElementById('attendance-month-selector').value;
            
            // Cập nhật tháng hiện tại cho bộ lọc học phí và doanh thu
            currentMonth = monthYear;
            document.getElementById('tuition-month-selector').value = monthYear;
            
            let filteredStudents = students;
            if (filterClass !== 'all') {
                filteredStudents = filteredStudents.filter(s => s.classId === filterClass);
            }
            filteredStudents.sort((a, b) => a.name.localeCompare(b.name, 'vi', { sensitivity: 'base' }));
            
            if (filteredStudents.length === 0) {
                container.innerHTML = `<p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Không tìm thấy học sinh nào trong lớp này.</p>`;
                return;
            }

            // Tiêu đề cột buổi học
            const sessionHeaders = Array.from({ length: 10 }, (_, i) => 
                `<th class="px-3 py-1 text-center text-xs font-semibold text-indigo-700 uppercase border-t border-gray-200">Buổi ${i + 1}</th>`
            ).join('');
            
            const rows = filteredStudents.map(s => {
                const record = getAttendanceRecord(s.id, monthYear);
                const sessions = record ? record.sessions : {};
                const note = record ? record.note : ''; 
                
                const sessionCells = Array.from({ length: 10 }, (_, i) => {
                    const sessionNum = i + 1;
                    const sessionNumStr = sessionNum.toString();
                    
                    // Lấy session object, đảm bảo default nếu chưa có
                    const sessionData = sessions[sessionNumStr] || createDefaultSession();
                    const isPresent = sessionData.isPresent; 
                    const sessionDate = sessionData.date || '';

                    // Checkbox cho buổi học VÀ INPUT DATE THEO YÊU CẦU
                    return `
                        <td class="p-2 text-center align-top" style="min-width: 120px;">
                            <div class="flex flex-col items-center space-y-2">
                                <input type="date" 
                                    value="${sessionDate}"
                                    onchange="updateSessionDate('${s.id}', ${sessionNum}, this)"
                                    class="w-full text-xs p-1 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                                    title="Chọn ngày buổi ${sessionNum}"
                                >
                                <input type="checkbox" 
                                    class="form-checkbox h-6 w-6 text-indigo-600 rounded-lg border-gray-300 focus:ring-indigo-500 cursor-pointer transition duration-150 transform hover:scale-110" 
                                    ${isPresent ? 'checked' : ''}
                                    onclick="updateAttendance('${s.id}', ${sessionNum})"
                                    title="Điểm danh buổi ${sessionNum}"
                                >
                            </div>
                        </td>
                    `;
                }).join('');

                return `
                    <tr class="border-b last:border-b-0 hover:bg-indigo-50 transition duration-150">
                        <td class="p-3 text-sm font-semibold text-gray-800 sticky left-0 bg-white border-r w-40">${s.name}</td>
                        <td class="p-3 text-sm text-center w-16">
                            <span class="inline-block px-3 py-1 text-xs font-bold rounded-full bg-blue-100 text-blue-700">${s.classId}</span>
                        </td>
                        ${sessionCells}
                        <td class="p-2 text-sm w-48">
                            <textarea 
                                onblur="handleUpdateTuitionNote('${s.id}', '${monthYear}', this)"
                                class="w-full text-xs p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 
                                transition duration-150 custom-scrollbar resize-none h-24" 
                                placeholder="Ghi chú về buổi học/học sinh..."
                            >${note}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="overflow-x-auto rounded-2xl shadow-lg border border-gray-100 mt-6 custom-scrollbar">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider sticky left-0 bg-indigo-50 border-r w-40" rowspan="2">Tên Học Sinh</th>
                                <th class="px-3 py-3 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider w-16" rowspan="2">Lớp</th>
                                <th class="px-3 py-3 text-center text-sm font-bold text-indigo-700 uppercase tracking-wider" colspan="10">Điểm Danh Theo KHÓA 10 BUỔI (Ngày Học & Trạng Thái)</th>
                                <th class="px-3 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider w-48" rowspan="2">LƯU Ý</th>
                            </tr>
                            <tr>
                                ${sessionHeaders}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">${rows}</tbody>
                    </table>
                </div>
            `;
        };
        window.renderAttendanceView = renderAttendanceView;

        const renderTuitionTable = () => {
            const container = document.getElementById('tuition-table-container');
            const filterClass = document.getElementById('tuition-filter-class').value;
            const monthYear = document.getElementById('tuition-month-selector').value;
            
            let filteredStudents = students.slice();
            if (filterClass !== 'all') {
                filteredStudents = filteredStudents.filter(s => s.classId === filterClass);
            }
            filteredStudents.sort((a, b) => a.name.localeCompare(b.name, 'vi', { sensitivity: 'base' }));
            
            if (filteredStudents.length === 0) {
                container.innerHTML = `<p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Không tìm thấy học sinh nào trong lớp này.</p>`;
                return;
            }

            let totalRevenueMonth = 0;
            let totalRevenuePaid = 0; // BIẾN MỚI: Tổng thu nhập đã nộp

            const rows = filteredStudents.map(s => {
                const record = getAttendanceRecord(s.id, monthYear);
                const sessions = record ? record.sessions : {};
                const isPaid = record ? record.isPaid : false; 
                const note = record ? record.note : ''; 
                
                // Đếm số buổi có mặt (sử dụng cấu trúc mới)
                const attendedCount = Object.keys(sessions).reduce((count, key) => {
                    const sessionData = sessions[key] || createDefaultSession();
                    return sessionData.isPresent === true ? count + 1 : count;
                }, 0);
             
                const tuitionRate = s.tuitionRate || CLASS_RATES[s.classId] || 0;
                const monthlyTuition = attendedCount * tuitionRate;
                totalRevenueMonth += monthlyTuition;

                if (isPaid) {
                    totalRevenuePaid += monthlyTuition; // CỘNG VÀO TỔNG ĐÃ NỘP
                }

                // Trạng thái khóa học (giả định khóa 10 buổi)
                let statusBadge = '';
                let badgeClass = 'bg-gray-100 text-gray-700';
                let statusText = `${attendedCount}/${MAX_SESSIONS} Buổi`;

                if (attendedCount === MAX_SESSIONS) {
                    badgeClass = 'bg-indigo-100 text-indigo-700';
                    statusText = 'Hoàn Thành Khóa';
                } else if (attendedCount > 0) {
                    badgeClass = 'bg-yellow-100 text-yellow-700';
                    statusText = `Đang Học (${attendedCount} B.)`;
                } else {
                    badgeClass = 'bg-gray-100 text-gray-700';
                    statusText = 'Chưa Bắt Đầu';
                }
                statusBadge = `<span class="inline-block px-3 py-1 text-xs font-bold rounded-full ${badgeClass}">${statusText}</span>`;


                // Trạng thái thanh toán
                const paymentStatusBadge = isPaid 
                    ? `<span class="inline-block px-3 py-1 text-xs font-bold rounded-full bg-green-100 text-green-700">Đã nộp</span>`
                    : `<span class="inline-block px-3 py-1 text-xs font-bold rounded-full bg-red-100 text-red-700">Chưa nộp</span>`;
                
                // Nút chuyển trạng thái
                const toggleButton = `
                    <button onclick="handleTuitionPayment('${s.id}', '${monthYear}')"
                        class="px-3 py-2 text-xs font-bold rounded-xl text-white transition duration-150 ${isPaid ? 'bg-red-500 hover:bg-red-600' : 'bg-green-600 hover:bg-green-700'}">
                        ${isPaid ? 'HỦY NỘP' : 'XÁC NHẬN NỘP'}
                    </button>
                `;

                return `
                    <tr class="border-b last:border-b-0 hover:bg-indigo-50 transition duration-150">
                        <td class="p-4 text-sm font-semibold text-gray-800 w-40">${s.name}</td>
                        <td class="p-4 text-sm text-center w-16">${s.classId}</td>
                        <td class="p-4 text-sm text-right font-medium text-gray-600 w-24">${formatCurrency(tuitionRate)}</td>
                        <td class="p-4 text-center w-24">${statusBadge}</td>
                        <td class="p-4 text-lg font-extrabold text-right text-indigo-600 w-32">${formatCurrency(monthlyTuition)}</td>
                        <td class="p-4 text-center w-24">${paymentStatusBadge}</td>
                        <td class="p-4 text-center w-48">${toggleButton}</td>
                        <td class="p-2 text-sm w-48">
                            <textarea onblur="handleUpdateTuitionNote('${s.id}', '${monthYear}', this)"
                                class="w-full text-xs p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 custom-scrollbar resize-none h-16" 
                                placeholder="Ghi chú về học phí/thanh toán..." 
                            >${note}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="p-4 bg-indigo-100 rounded-2xl shadow-inner mb-4 flex justify-between items-center">
                    <div>
                        <p class="text-sm font-semibold text-indigo-700">TỔNG TIỀN CẦN THU (KHÓA):</p>
                        <p class="text-3xl font-extrabold text-indigo-800">${formatCurrency(totalRevenueMonth)}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-green-700">TỔNG THỰC THU (ĐÃ NỘP):</p>
                        <p class="text-3xl font-extrabold text-green-800">${formatCurrency(totalRevenuePaid)}</p>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-2xl shadow-lg border border-gray-100 mt-6 custom-scrollbar">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th scope="col" class="px-4 py-4 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider w-40">Tên Học Sinh</th>
                                <th scope="col" class="px-4 py-4 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider w-16">Lớp</th>
                                <th scope="col" class="px-4 py-4 text-right text-xs font-bold text-indigo-700 uppercase tracking-wider w-24">HP/Buổi</th>
                                <th scope="col" class="px-4 py-4 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider w-24">Trạng Thái Khóa (10 B.)</th>
                                <th scope="col" class="px-4 py-4 text-right text-xs font-bold text-indigo-700 uppercase tracking-wider w-32">Tổng Cần Thu (Khóa)</th>
                                <th scope="col" class="px-4 py-4 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider w-24">Trạng Thái Thanh Toán</th>
                                <th scope="col" class="px-4 py-4 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider w-48">Hành Động</th>
                                <th scope="col" class="px-4 py-4 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider w-48">GHI CHÚ HP</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">${rows}</tbody>
                    </table>
                </div>
            `;
        };
        window.renderTuitionTable = renderTuitionTable;
        
        // --- MODULE NHẬN XÉT ĐÁNH GIÁ (UPDATED) ---

        /** Cập nhật một trường dữ liệu nhận xét */
        window.handleUpdateReview = (studentId, sessionNum, field, value) => {
            const monthYear = document.getElementById('review-month-selector').value;
            const recordId = `${studentId}-${monthYear}`;
            let record = getAttendanceRecord(studentId, monthYear);
            const sessionNumStr = sessionNum.toString();

            if (!record) {
                // Tạo mới record nếu chưa có
                const student = students.find(s => s.id === studentId);
                if (!student) return;

                let sessions = {};
                for(let i=1; i<=MAX_SESSIONS; i++) {
                    sessions[i.toString()] = createDefaultSession();
                }

                let sessionReviews = {};
                for(let i=1; i<=MAX_SESSIONS; i++) {
                    sessionReviews[i.toString()] = createDefaultReview();
                }
                
                record = { 
                    id: recordId, 
                    studentId: studentId, 
                    classId: student.classId, 
                    monthYear: monthYear, 
                    sessions: sessions, 
                    isPaid: false, 
                    note: '', 
                    sessionReviews: sessionReviews 
                };
                attendanceRecords.push(record);
            }

            // Đảm bảo review object tồn tại cho session đó 
            if (!record.sessionReviews) record.sessionReviews = {};
            if (!record.sessionReviews[sessionNumStr]) record.sessionReviews[sessionNumStr] = createDefaultReview(); 
            
            // Cập nhật trường dữ liệu
            record.sessionReviews[sessionNumStr][field] = value.toString().trim(); // Lưu dưới dạng string (có thể là điểm hoặc nhận xét)
            saveData('attendance', attendanceRecords);
            // Không cần render lại toàn bộ, chỉ cần lưu dữ liệu
        };

        const renderReviewView = () => {
            const container = document.getElementById('review-table-container');
            const filterClass = document.getElementById('review-filter-class').value;
            const monthYear = document.getElementById('review-month-selector').value;
            const sessionNum = document.getElementById('review-session-selector').value;

            if (sessionNum === 'all') {
                container.innerHTML = `<p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Vui lòng chọn một **Buổi học** cụ thể để xem và nhập nhận xét chi tiết.</p>`;
                return;
            }

            let filteredStudents = students;
            if (filterClass !== 'all') {
                filteredStudents = filteredStudents.filter(s => s.classId === filterClass);
            }
            filteredStudents.sort((a, b) => a.name.localeCompare(b.name, 'vi', { sensitivity: 'base' }));

            if (filteredStudents.length === 0) {
                container.innerHTML = `<p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Không tìm thấy học sinh nào trong lớp này.</p>`;
                return;
            }

            // Helper cho các trường Select (ĐÃ CẬP NHẬT KÍCH THƯỚC LỚN HƠN)
            const selectOptions = (currentValue, options, fieldName, studentId, sessionNum) => {
                let htmlOptions = '';
                // Nếu là trường điểm, tạo options từ 1 đến 10
                if (!options) { 
                    htmlOptions += `<option value="" ${currentValue === '' ? 'selected' : ''}>---</option>`;
                    for (let i = 10; i >= 1; i--) {
                        htmlOptions += `<option value="${i}" ${currentValue.toString() === i.toString() ? 'selected' : ''}>${i}</option>`;
                    }
                } else {
                    // Nếu là các trường trạng thái, sử dụng options truyền vào
                    htmlOptions = options.map(o => 
                        `<option value="${o}" ${currentValue === o ? 'selected' : ''}>${o}</option>`
                    ).join('');
                }

                return `<select onchange="handleUpdateReview('${studentId}', ${sessionNum}, '${fieldName}', this.value)"
                            class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-2 text-sm text-gray-700 bg-white h-10 transition duration-150">
                            ${htmlOptions}
                        </select>`;
            };

            // Helper cho các trường Nhận xét (ĐÃ CẬP NHẬT KÍCH THƯỚC RẤT LỚN VÀ CHỮ LỚN HƠN)
            const noteTextarea = (currentNote, fieldName, studentId, sessionNum) => {
                const safeCurrentNote = (currentNote || '').replace(/"/g, '&quot;');
                // Đã tăng chiều cao lên h-48 (gấp đôi h-24) và cỡ chữ lên text-base (16px) và padding lên p-4
                return `<textarea onblur="handleUpdateReview('${studentId}', ${sessionNum}, '${fieldName}', this.value)"
                    class="w-full text-base p-4 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 resize-none h-48 custom-scrollbar shadow-sm"
                    placeholder="Nhận xét chi tiết..." 
                >${safeCurrentNote}</textarea>`;
            };

            const rows = filteredStudents.map(s => {
                const record = getAttendanceRecord(s.id, monthYear);
                // Lấy thông tin nhận xét. Nếu không có record hoặc review, sử dụng default.
                let review = createDefaultReview();
                if (record && record.sessionReviews && record.sessionReviews[sessionNum]) {
                    // Sử dụng Object.assign hoặc spread để merge, đảm bảo các trường mới vẫn có default
                    review = Object.assign(review, record.sessionReviews[sessionNum]);
                }
                
                // Kiểm tra trạng thái điểm danh buổi này (cho tiện tham khảo)
                const isPresent = record && record.sessions[sessionNum] && record.sessions[sessionNum].isPresent === true;
                const rowClass = isPresent ? 'bg-green-50 hover:bg-green-100' : 'hover:bg-indigo-50';

                return `
                    <tr class="border-b last:border-b-0 ${rowClass} transition duration-150">
                        <td class="p-3 text-sm font-semibold text-gray-800 sticky left-0 bg-white border-r w-40">${s.name}</td>
                        <td class="p-3 text-sm text-center w-16">${s.classId}</td>
                        <td class="p-2 w-32">${selectOptions(review.attitude, REVIEW_ATTITUDE_OPTIONS, 'attitude', s.id, sessionNum)}</td>
                        <td class="p-2 w-64">${noteTextarea(review.homeworkNote, 'homeworkNote', s.id, sessionNum)}</td>
                        <td class="p-2 w-32">${selectOptions(review.homeworkStatus, REVIEW_HW_STATUS_OPTIONS, 'homeworkStatus', s.id, sessionNum)}</td>
                        <td class="p-2 w-20">${selectOptions(review.homeworkScore, null, 'homeworkScore', s.id, sessionNum)}</td>
                        <td class="p-2 w-64">${noteTextarea(review.oldLessonNote, 'oldLessonNote', s.id, sessionNum)}</td>
                        <td class="p-2 w-20">${selectOptions(review.oldLessonScore, null, 'oldLessonScore', s.id, sessionNum)}</td>
                        <td class="p-2 w-64">${noteTextarea(review.testNote, 'testNote', s.id, sessionNum)}</td>
                        <td class="p-2 w-20">${selectOptions(review.testScore, null, 'testScore', s.id, sessionNum)}</td>
                        <td class="p-2 w-20">${selectOptions(review.averageScore, null, 'averageScore', s.id, sessionNum)}</td>
                    </tr>
                `;
            }).join('');

            // Cấu trúc tiêu đề bảng (LÀM LẠI THEO YÊU CẦU DỮ LIỆU BỰ BỰ)
            const tableHeaders = `
                <tr>
                    <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider sticky left-0 bg-indigo-50 border-r w-40">Tên Học Sinh</th>
                    <th rowspan="2" class="px-3 py-3 text-center text-xs font-bold text-indigo-700 uppercase tracking-wider w-16">Lớp</th>
                    <th colspan="2" class="px-2 py-3 text-center text-sm font-bold text-indigo-700 uppercase tracking-wider border-l border-gray-200">Thái Độ / Tự Giác</th>
                    <th colspan="2" class="px-2 py-3 text-center text-sm font-bold text-indigo-700 uppercase tracking-wider border-l border-gray-200">Bài Tập Về Nhà (BTVN)</th>
                    <th colspan="2" class="px-2 py-3 text-center text-sm font-bold text-indigo-700 uppercase tracking-wider border-l border-gray-200">Kiểm Tra Bài Cũ</th>
                    <th colspan="2" class="px-2 py-3 text-center text-sm font-bold text-indigo-700 uppercase tracking-wider border-l border-gray-200">Bài Kiểm Tra (Test)</th>
                    <th colspan="1" rowspan="2" class="px-2 py-3 text-center text-sm font-bold text-indigo-700 uppercase tracking-wider border-l border-gray-200 w-20">ĐIỂM TRUNG BÌNH</th>
                </tr>
            `;

            const subHeaders = `
                <tr class="bg-indigo-100">
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 border-t border-l w-32">Trạng Thái</th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 border-t w-64">Nhận Xét</th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 border-t border-l w-32">Trạng Thái</th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 border-t w-20">Điểm</th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 border-t w-64">Nhận Xét</th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 border-t border-l w-20">Điểm</th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 border-t w-64">Nhận Xét</th>
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 border-t border-l w-20">Điểm</th>
                </tr>
            `;


            container.innerHTML = `
                <h4 class="text-xl font-semibold text-indigo-700 mb-4">Buổi Học ${sessionNum} - Tháng ${monthYear.substring(5, 7)}/${monthYear.substring(0, 4)}</h4>
                <div class="overflow-x-auto rounded-2xl shadow-lg border border-gray-100 mt-2 custom-scrollbar">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50 sticky top-0">
                            ${tableHeaders}
                            ${subHeaders}
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">${rows}</tbody>
                    </table>
                </div>
            `;
        };
        window.renderReviewView = renderReviewView;
        
        // --- MODULE DOANH THU TỔNG HỢP (GIỮ NGUYÊN LOGIC) --- 
        const calculateMonthlyIncome = (monthYear) => {
            let monthlyRevenue = 0;
            const studentsMap = students.reduce((acc, s) => { acc[s.id] = s; return acc; }, {});
            
            // Lọc các bản ghi điểm danh trong tháng được chọn
            const monthRecords = attendanceRecords.filter(r => r.monthYear === monthYear);

            monthRecords.forEach(record => { 
                const student = studentsMap[record.studentId];
                if (student) {
                    const sessions = record.sessions || {};
                    // Đếm số buổi có mặt (sử dụng cấu trúc mới)
                    const attendedCount = Object.keys(sessions).reduce((count, key) => {
                         const sessionData = sessions[key] || createDefaultSession();
                         return sessionData.isPresent === true ? count + 1 : count;
                    }, 0);
                    
                    const tuitionRate = student.tuitionRate || CLASS_RATES[student.classId] || 0;
                    // LƯU Ý: Dashboard vẫn tính tổng thu nhập dựa trên số buổi đã đi học (Cần Thu), không dựa trên trạng thái đã nộp
                    monthlyRevenue += attendedCount * tuitionRate;
                } 
            });
            return monthlyRevenue;
        };

        const renderIncomeDashboard = () => {
            const monthYear = document.getElementById('income-month-selector').value;
            const revenue = calculateMonthlyIncome(monthYear);

            // Tìm 3 tháng gần nhất để so sánh
            const date = new Date(monthYear + '-01');
            const months = [];
            // Lùi lại 2 tháng
            const tempDate = new Date(date);
            tempDate.setMonth(date.getMonth() - 2); 

            for(let i = 0; i < 3; i++) {
                const year = tempDate.getFullYear();
                const month = tempDate.getMonth() + 1; // 1-12
                const monthStr = month.toString().padStart(2, '0');
                const comparisonMonthYear = `${year}-${monthStr}`;
                const comparisonRevenue = calculateMonthlyIncome(comparisonMonthYear);
                
                months.push({
                    monthYear: comparisonMonthYear,
                    revenue: comparisonRevenue,
                    isCurrent: comparisonMonthYear === monthYear
                });

                tempDate.setMonth(tempDate.getMonth() + 1);
            }

            // Tính toán tỷ lệ phần trăm cho biểu đồ cột
            const maxRevenue = Math.max(...months.map(m => m.revenue), 1); // Tránh chia cho 0
            const barChartHTML = months.map(d => {
                const heightPercent = (d.revenue / maxRevenue) * 100;
                const displayMonth = `${d.monthYear.substring(5, 7)}/${d.monthYear.substring(0, 4)}`;
                const isCurrent = d.isCurrent;

                return `
                    <div class="flex flex-col items-center w-1/3 p-2">
                        <div class="relative w-full h-[150px] bg-gray-100 rounded-lg border border-gray-300">
                            <div class="absolute bottom-0 w-full rounded-b-lg transition-all duration-700 ease-out ${isCurrent ? 'bg-indigo-600 shadow-lg shadow-indigo-500/50' : 'bg-green-500 shadow-md shadow-green-400/50'}" style="height: ${heightPercent}%;">
                                <span class="absolute top-[-25px] left-1/2 transform -translate-x-1/2 text-xs font-bold text-gray-700 w-max">${formatCurrency(d.revenue)}</span>
                            </div>
                        </div>
                        <p class="mt-2 text-xs font-medium text-gray-600">${displayMonth}</p>
                    </div>
                `;
            }).join('');

            document.getElementById('dashboard-monthly-revenue').textContent = formatCurrency(revenue);
            document.getElementById('dashboard-student-count').textContent = students.length;
            document.getElementById('monthly-comparison-chart').innerHTML = barChartHTML;
        };
        window.renderIncomeDashboard = renderIncomeDashboard;

        // --- CÁC HÀM XỬ LÝ MODAL (POPUP) ---
        window.closeModal = () => {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.add('hidden'); // Đảm bảo modal edit cũng đóng
        };
        window.showModal = (title, message, callback = null, isDanger = false) => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmButton = document.getElementById('modal-confirm-btn');
            const cancelButton = document.getElementById('modal-cancel-btn');

            // Đặt lại style cơ bản cho nút Xác nhận
            confirmButton.className = 'px-6 py-3 text-sm font-bold rounded-xl text-white transition duration-200 transform hover:scale-[1.03] focus:outline-none focus:ring-4';

            if (callback) {
                // Xác nhận/Danger mode
                confirmButton.classList.remove('hidden');
                cancelButton.classList.remove('hidden');
                if (isDanger) {
                    confirmButton.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-300');
                    confirmButton.textContent = 'Xác Nhận Xóa';
                } else {
                    confirmButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-300');
                    confirmButton.textContent = 'Xác Nhận';
                }
                
                // Gán lại hàm callback (phải dùng cloneNode để gỡ bỏ listener cũ)
                const oldConfirmBtn = confirmButton;
                const newConfirmBtn = oldConfirmBtn.cloneNode(true);
                oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);
                newConfirmBtn.addEventListener('click', () => {
                    callback();
                    closeModal();
                });
                
            } else {
                // Thông báo đơn giản
                confirmButton.classList.remove('hidden');
                confirmButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-300');
                confirmButton.textContent = 'Đã Hiểu';
                cancelButton.classList.add('hidden');
                
                // Gán lại hàm đóng modal
                const oldConfirmBtn = confirmButton;
                const newConfirmBtn = oldConfirmBtn.cloneNode(true);
                oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);
                newConfirmBtn.addEventListener('click', closeModal);
            }
            
            modal.classList.remove('hidden');
        };
        
        // --- KHỞI TẠO APP ---
        document.addEventListener('DOMContentLoaded', () => {
            // Lấy danh sách lớp học để điền vào Select Options
            const classSelects = document.querySelectorAll('.class-select-options');
            const optionsHtml = CLASS_OPTIONS.map(c => `<option value="${c}">${c}</option>`).join('');
            classSelects.forEach(select => {
                select.innerHTML = `<option value="all">Tất cả các lớp</option>` + optionsHtml;
            });

            // Điền options cho Session Review
            const reviewSessionSelector = document.getElementById('review-session-selector');
            const sessionOptions = Array.from({ length: MAX_SESSIONS }, (_, i) => 
                `<option value="${i + 1}">Buổi ${i + 1}</option>`
            ).join('');
            reviewSessionSelector.innerHTML = `<option value="all">--- Chọn Buổi Học ---</option>` + sessionOptions;

            // Thiết lập tháng mặc định cho các bộ lọc
            const currentMonthYear = new Date().toISOString().substring(0, 7);
            document.getElementById('attendance-month-selector').value = currentMonthYear;
            document.getElementById('tuition-month-selector').value = currentMonthYear;
            document.getElementById('income-month-selector').value = currentMonthYear;

            // Nếu chưa đăng nhập, chỉ hiển thị màn hình đăng nhập
            if (!loggedIn) {
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            } else {
                loadInitialData();
                switchView(currentView);
            }
        });

    </script>
</head>
<body>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Chỉnh Sửa Thông Tin Học Sinh</h3>
            <form onsubmit="event.preventDefault(); submitEditStudent();">
                <input type="hidden" id="edit-student-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-student-name" class="block text-sm font-medium text-gray-700 mb-1">Tên Học Sinh</label>
                        <input type="text" id="edit-student-name" required class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 text-gray-700">
                    </div>
                    <div>
                        <label for="edit-student-class" class="block text-sm font-medium text-gray-700 mb-1">Lớp Học</label>
                        <select id="edit-student-class" required class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 text-gray-700 bg-white">
                            </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-6 py-3 text-sm font-bold rounded-xl text-gray-700 border border-gray-300 hover:bg-gray-100 transition duration-200">
                        Hủy
                    </button>
                    <button type="submit" class="px-6 py-3 text-sm font-bold rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        Lưu Thay Đổi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-700 to-purple-800 p-4">
        <div class="bg-white p-8 md:p-12 rounded-3xl shadow-2xl w-full max-w-sm card-premium transform hover:scale-[1.03]">
            <div class="text-center mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-600 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 016 0h2a5 5 0 00-5-5z" /></svg>
                <h1 class="text-3xl font-extrabold text-gray-900 mt-3">Quản Lý Trung Tâm</h1>
                <p class="text-sm text-gray-500">Toán Cô Huyền</p>
            </div>
            <form onsubmit="event.preventDefault(); handleLogin();">
                <div class="space-y-4">
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu Admin (Demo: admin)</label>
                        <input type="password" id="admin-password" required placeholder="Nhập mật khẩu" class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 text-gray-700">
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 px-6 py-3 text-lg font-bold rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300 shadow-lg shadow-indigo-500/50 transform hover:scale-[1.01]">
                    Đăng Nhập
                </button>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden min-h-screen flex">
        
        <aside class="w-64 bg-white border-r border-gray-100 p-4 sticky top-0 h-screen hidden md:block shadow-xl">
            <div class="text-center py-4 border-b border-gray-100 mb-6">
                <h2 class="text-xl font-extrabold text-gray-900">MATH CENTER</h2>
                <p class="text-xs text-gray-500">Quản Lý Tuyệt Vời</p>
            </div>
            <nav id="nav-bar" class="space-y-2">
                <button onclick="switchView('dashboard')" class="nav-btn active w-full flex items-center space-x-3 px-4 py-3 text-base font-semibold rounded-xl text-gray-700 hover:bg-indigo-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    <span>Dashboard</span>
                </button>
                <button onclick="switchView('students')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-base font-semibold rounded-xl text-gray-700 hover:bg-indigo-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2h2M17 20h3M14 10h.01M7 10h.01M21 21l-9-9 9-9h-7a2 2 0 00-2 2v4a2 2 0 002 2h4a2 2 0 002-2v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4a2 2 0 002 2h4M7 4h7a5 5 0 015 5v12a2 2 0 002 2H3a2 2 0 002-2v-7a2 2 0 012-2z" /></svg> 
                    <span>Danh Sách Học Sinh</span>
                </button>
                <button onclick="switchView('attendance')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-base font-semibold rounded-xl text-gray-700 hover:bg-indigo-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-5 3h4a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                    <span>Điểm Danh</span>
                </button>
                <button onclick="switchView('tuition')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-base font-semibold rounded-xl text-gray-700 hover:bg-indigo-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span>Học Phí</span>
                </button>
                <button onclick="switchView('reviews')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 text-base font-semibold rounded-xl text-gray-700 hover:bg-indigo-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    <span>Nhận Xét Chi Tiết</span>
                </button>
            </nav>
            <div class="mt-8 pt-4 border-t border-gray-100">
                <button onclick="handleLogout()" class="w-full flex items-center space-x-3 px-4 py-3 text-base font-semibold rounded-xl text-red-600 bg-red-50 hover:bg-red-100 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span>Đăng Xuất</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto">
            <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                <h1 class="text-2xl font-bold text-gray-900">Quản Lý Trung Tâm Toán Cô Huyền</h1>
                <span id="header-status" class="text-sm font-medium text-indigo-600">Đã đăng nhập (Admin)</span>
            </header>

            <div id="dashboard" class="app-view main-content-area py-8 px-4">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">📊 Dashboard Tổng Hợp</h2>
                
                <div class="mb-6 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 items-end">
                    <div class="w-full md:w-auto">
                        <label for="income-month-selector" class="block text-sm font-medium text-gray-700 mb-1">Chọn Tháng/Khóa:</label>
                        <input type="month" id="income-month-selector" onchange="renderIncomeDashboard()" class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 bg-white">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-6 rounded-2xl shadow-xl shadow-indigo-500/30 transform hover:scale-[1.03] transition duration-300">
                        <p class="text-sm font-semibold opacity-90">DOANH THU CẦN THU (KHÓA)</p>
                        <p id="dashboard-monthly-revenue" class="text-4xl font-extrabold mt-2 tracking-tight">0 VND</p>
                        <div class="flex items-center justify-between mt-3 text-sm opacity-80">
                            <span class="font-light">Dự kiến thu từ số buổi đã học.</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-teal-500 to-cyan-600 text-white p-6 rounded-2xl shadow-xl shadow-teal-500/30 transform hover:scale-[1.03] transition duration-300">
                        <p class="text-sm font-semibold opacity-90">TỔNG SỐ HỌC SINH</p>
                        <p id="dashboard-student-count" class="text-4xl font-extrabold mt-2 tracking-tight">0</p>
                        <div class="flex items-center justify-between mt-3 text-sm opacity-80">
                            <span class="font-light">Số lượng đang học tại trung tâm.</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2h2M17 20h3M14 10h.01M7 10h.01M21 21l-9-9 9-9h-7a2 2 0 00-2 2v4a2 2 0 002 2h4a2 2 0 002-2v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4a2 2 0 002 2h4M7 4h7a5 5 0 015 5v12a2 2 0 002 2H3a2 2 0 002-2v-7a2 2 0 012-2z" /></svg>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                        <p class="text-sm font-semibold text-gray-700">SO SÁNH 3 KHÓA GẦN NHẤT (Cần Thu)</p>
                        <div id="monthly-comparison-chart" class="flex justify-around items-end h-40 mt-4">
                            </div>
                    </div>
                </div>
            </div>
            
            <div id="students" class="app-view hidden main-content-area py-8 px-4">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">🧑‍🎓 Quản Lý Học Sinh</h2>
                
                <div class="card-premium bg-white p-6 md:p-8 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Thêm Học Sinh Mới</h3>
                    <form onsubmit="handleAddStudent(event)" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="new-student-name" class="block text-sm font-medium text-gray-700 mb-1">Tên Học Sinh</label>
                            <input type="text" id="new-student-name" required placeholder="Nguyễn Văn A" class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3">
                        </div>
                        <div>
                            <label for="new-student-class" class="block text-sm font-medium text-gray-700 mb-1">Chọn Lớp</label>
                            <select id="new-student-class" required class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 text-gray-700 bg-white">
                                </select>
                        </div>
                        <div>
                            <button type="submit" class="w-full flex items-center justify-center space-x-2 px-4 py-3 text-sm font-bold rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                <span>Thêm</span>
                            </button>
                        </div>
                    </form>
                </div>

                <h3 class="text-2xl font-bold text-gray-800 mb-4">Danh Sách Học Sinh Hiện Có</h3>
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 items-end p-5 bg-gray-50 rounded-2xl border border-gray-200 shadow-inner">
                    <div class="w-full md:flex-1">
                        <label for="student-search-name" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm theo Tên:</label>
                        <input type="text" id="student-search-name" oninput="renderStudentList()" placeholder="Nhập tên học sinh..." class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3">
                    </div>
                    <div class="w-full md:w-1/3">
                        <label for="student-filter-class" class="block text-sm font-medium text-gray-700 mb-1">Lọc theo Lớp:</label>
                        <select id="student-filter-class" onchange="renderStudentList()" class="form-input-style class-select-options block w-full rounded-xl border border-gray-300 shadow-sm p-3 bg-white">
                        </select>
                    </div>
                </div>

                <div class="mt-6" id="student-list-container">
                    <p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Vui lòng thêm học sinh để hiển thị danh sách.</p>
                </div>
            </div>
            
            <div id="attendance" class="app-view hidden main-content-area py-8 px-4">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">📅 Điểm Danh Học Sinh</h2>
                
                <div class="card-premium bg-white p-6 md:p-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Bộ Lọc & Chọn Khóa (Tháng)</h3>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 items-end p-5 bg-gray-50 rounded-2xl border border-gray-200 shadow-inner">
                        <div class="w-full md:w-auto">
                            <label for="attendance-month-selector" class="block text-sm font-medium text-gray-700 mb-1">Chọn Khóa/Tháng:</label>
                            <input type="month" id="attendance-month-selector" onchange="renderAttendanceView()" class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 bg-white">
                        </div>
                        <div class="w-full md:w-1/3">
                            <label for="attendance-filter-class" class="block text-sm font-medium text-gray-700 mb-1">Lọc theo Lớp:</label>
                            <select id="attendance-filter-class" onchange="renderAttendanceView()" class="form-input-style class-select-options block w-full rounded-xl border border-gray-300 shadow-sm p-3 bg-white">
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="attendance-table-container">
                    <p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Vui lòng chọn Lớp và Tháng để hiển thị danh sách điểm danh.</p>
                </div>
            </div>
            
            <div id="tuition" class="app-view hidden main-content-area py-8 px-4">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">💰 Quản Lý Học Phí (Khóa 10 Buổi)</h2>
                
                <div class="card-premium bg-white p-6 md:p-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Bộ Lọc & Trạng Thái Khóa</h3>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 items-end p-5 bg-gray-50 rounded-2xl border border-gray-200 shadow-inner">
                        <div class="w-full md:w-auto">
                            <label for="tuition-month-selector" class="block text-sm font-medium text-gray-700 mb-1">Chọn Khóa/Tháng:</label>
                            <input type="month" id="tuition-month-selector" onchange="renderTuitionTable()" class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 bg-white">
                        </div>
                        <div class="w-full md:w-1/3">
                            <label for="tuition-filter-class" class="block text-sm font-medium text-gray-700 mb-1">Lọc theo Lớp:</label>
                            <select id="tuition-filter-class" onchange="renderTuitionTable()" class="form-input-style class-select-options block w-full rounded-xl border border-gray-300 shadow-sm p-3 bg-white">
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="tuition-table-container">
                    <p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Vui lòng chọn Lớp và Tháng để hiển thị danh sách học phí.</p>
                </div>
            </div>

            <div id="reviews" class="app-view hidden main-content-area py-8 px-4">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">📝 Nhận Xét Chi Tiết Học Sinh</h2>
                
                <div class="card-premium bg-white p-6 md:p-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Bộ Lọc & Chọn Buổi Học</h3>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 items-end p-5 bg-gray-50 rounded-2xl border border-gray-200 shadow-inner">
                        <div class="w-full md:w-auto">
                            <label for="review-month-selector" class="block text-sm font-medium text-gray-700 mb-1">Chọn Tháng/Khóa:</label>
                            <input type="month" id="review-month-selector" onchange="renderReviewView()" class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 bg-white">
                        </div>
                        <div class="w-full md:w-1/3">
                            <label for="review-filter-class" class="block text-sm font-medium text-gray-700 mb-1">Lọc theo Lớp:</label>
                            <select id="review-filter-class" onchange="renderReviewView()" class="form-input-style class-select-options block w-full rounded-xl border border-gray-300 shadow-sm p-3 bg-white">
                            </select>
                        </div>
                        <div class="w-full md:w-auto">
                            <label for="review-session-selector" class="block text-sm font-medium text-gray-700 mb-1">Chọn Buổi Học:</label>
                            <select id="review-session-selector" onchange="renderReviewView()" class="form-input-style block w-full rounded-xl border border-gray-300 shadow-sm p-3 text-gray-700 bg-white">
                                </select>
                        </div>
                    </div>
                </div>
                
                <div id="review-table-container">
                    <p class="p-6 text-gray-500 text-center bg-white rounded-2xl shadow-md border border-gray-200 mt-4">Vui lòng chọn Lớp, Tháng và Buổi học để nhập nhận xét.</p>
                </div>
            </div>
            
            </div>
    </div>
    
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl transform scale-100 transition duration-300">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4">Tiêu đề</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Nội dung thông báo.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" onclick="closeModal()" 
                        class="px-6 py-3 text-sm font-bold rounded-xl text-gray-700 border border-gray-300 hover:bg-gray-100 transition duration-200 hidden">
                    Hủy
                </button>
                <button id="modal-confirm-btn" 
                        class="px-6 py-3 text-sm font-bold rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    Đã Hiểu
                </button>
            </div>
        </div>
    </div>

</body>
</html>
