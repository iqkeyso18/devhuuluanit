<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trung Tâm Toán Cô Huyền - Nền Tảng Quản Lý Giáo Viên</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Màu sắc chủ đạo mới
                        'primary-blue': '#1D4ED8', // Xanh đậm, mạnh mẽ hơn
                        'secondary-orange': '#F59E0B', // Cam ấm áp, màu nhấn
                        'accent-green': '#10B981', // Xanh lá cây cho Success/Doanh thu
                        'light-bg': '#F9FAFB', // Nền siêu nhẹ
                        'card-border': '#E5E7EB', // Đường viền thẻ
                        'one-to-one-fee': '#7C3AED', // Màu tím cho phí 1-1 (Mục mới)
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6; /* Nền xám nhạt */
        }
        .card { 
            background-color: #ffffff;
            padding: 24px; 
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            /* Bóng đổ mềm hơn */
            border: 1px solid var(--card-border);
        }
        .input-field { 
            width: 100%;
            padding: 12px;
            border: 1px solid #D1D5DB; 
            border-radius: 8px; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus { 
            border-color: #1D4ED8;
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.2); 
            outline: none;
        }
        .btn-primary { 
            background-color: #1D4ED8;
            color: white; 
            padding: 12px 24px; 
            border-radius: 8px;
            font-weight: 600; 
            transition: background-color 0.2s, transform 0.1s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary:hover { 
            background-color: #3B82F6;
            transform: translateY(-1px);
        }
        .btn-secondary { 
            background-color: #F59E0B;
            color: white; 
            padding: 12px 24px; 
            border-radius: 8px;
            font-weight: 600; 
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-secondary:hover { 
            background-color: #F97316;
            transform: translateY(-1px);
        }
        .hero-banner { 
            /* ĐÃ SỬA LỖI HÌNH ẢNH: Thay thế URL ảnh ngoài bằng dải màu gradient thuần CSS */
            background: linear-gradient(135deg, #1D4ED8 0%, #3B82F6 100%);
            padding: 4rem 3rem; 
            border-radius: 16px; 
            margin-bottom: 2.5rem;
            color: white;
        }
        
        .responsive-table { 
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
        }
        .responsive-table th, .responsive-table td { 
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB; 
        }
        .responsive-table thead th { 
            background-color: #E0E7FF; /* Nền xanh nhạt cho header */
            color: #1D4ED8;
            font-weight: 700; 
            text-transform: uppercase; 
            font-size: 13px; 
            letter-spacing: 0.05em; 
        }
        .responsive-table tbody tr:hover { 
            background-color: #F9FAFB;
        }
        .responsive-table tbody tr:last-child td { 
            border-bottom: none;
        }
        /* Thêm style cho border radius ở góc bảng */
        .responsive-table thead tr:first-child th:first-child { border-top-left-radius: 12px; }
        .responsive-table thead tr:first-child th:last-child { border-top-right-radius: 12px; }
        .responsive-table tbody tr:last-child td:first-child { border-bottom-left-radius: 12px; }
        .responsive-table tbody tr:last-child td:last-child { border-bottom-right-radius: 12px; }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <i class="fas fa-graduation-cap text-3xl text-primary-blue"></i>
                <h1 onclick="app.renderDashboard()" class="text-3xl font-extrabold text-gray-900 cursor-pointer">
                    <span class="text-primary-blue">Toán</span> Cô Huyền
                </h1>
            </div>
            <nav id="nav" class="hidden md:flex space-x-6 font-semibold">
                <button onclick="app.renderDashboard()" class="text-gray-600 hover:text-primary-blue transition">Dashboard</button>
                <button onclick="app.renderStudentList()" class="text-gray-600 hover:text-primary-blue transition">Học Sinh</button>
                <button onclick="app.renderAttendance()" class="text-gray-600 hover:text-secondary-orange transition">Điểm Danh</button>
                <button onclick="app.renderFees()" class="text-gray-600 hover:text-accent-green transition">Học Phí</button>
                <button onclick="app.renderReports()" class="text-gray-600 hover:text-gray-500 transition">Báo Cáo</button>
            </nav>
            <div id="authSection">
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div id="mainContent">
        </div>
    </main>

    <div id="modalContainer">
    </div>

    <script>
        // ----------------------------------------
        // 1. CẤU HÌNH & DỮ LIỆU CƠ BẢN
        // ----------------------------------------
        const CONFIG = {
            FEE_PER_SESSION: 80000, // Lớp thường
            ONE_TO_ONE_FEE: 200000, // Lớp Kèm 1-1 (Mục mới)
            SESSIONS_PER_COURSE: 10 
        };
        const CLASSES = ['1-1']; // Thêm lớp Kèm 1-1
        for (let g = 4; g <= 9; g++) {
            for (let i = 1; i <= 3; i++) CLASSES.push(`${g}.${i}`);
        }

        /**
         * Lấy mức học phí theo loại lớp
         * @param {string} classId - ID của lớp
         * @returns {number} Mức học phí (VNĐ)
         */
        function getFeeByClass(classId) {
            return classId === '1-1' ? CONFIG.ONE_TO_ONE_FEE : CONFIG.FEE_PER_SESSION;
        }

        // ----------------------------------------
        // 2. DATABASE & LOGIC
        // ----------------------------------------
        const db = {
            get(key) { 
                try { 
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : (key === 'fees' || key === 'attendance' ? {} : []);
                } catch { 
                    return (key === 'fees' || key === 'attendance' ? {} : []);
                } 
            },
            set(key, val) { localStorage.setItem(key, JSON.stringify(val)); },
            init() {
                // Ensure Admin user exists
                let users = this.get('users');
                if (!users.some(u => u.username === 'admin')) {
                    users.push({ id: 'admin', name: 'Cô Huyền', role: 'teacher', username: 'admin', password: '123' });
                    this.set('users', users);
                }

                // Initialize Demo Students (Crucial for testing)
                let students = this.get('students');
                if (students.length === 0) {
                    const demoStudents = [];
                    for (let i = 1; i <= 30; i++) {
                        const classId = CLASSES[i % CLASSES.length];
                        demoStudents.push({
                            id: `s_${Date.now() + i}`,
                            name: `Học Sinh Vàng ${i}`,
                            phone: `0987${String(100 + i).padStart(3, '0')}`,
                            classId: classId
                        });
                    }
                    this.set('students', demoStudents);
                }
                
                // Initialize other data structures if not present
                if (!localStorage.getItem('fees')) this.set('fees', {});
                if (!localStorage.getItem('attendance')) this.set('attendance', {});

                // NEW: Ensure fee structure has history for all students (migration)
                let fees = this.get('fees');
                for (const studentId in fees) {
                    if (!fees[studentId].history) {
                        fees[studentId].history = [];
                    }
                    // FIX: Thêm trường debt vào cấu trúc fees
                    if (!fees[studentId].current) {
                        fees[studentId].current = { paid: 0, remaining: 0, debt: 0 }; 
                    } else if (fees[studentId].current.debt === undefined) {
                        fees[studentId].current.debt = 0; // Đảm bảo trường debt tồn tại trên records cũ
                    }
                }
                this.set('fees', fees);
            }
        };

        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        const auth = {
            login(u, p) {
                const users = db.get('users');
                const user = users.find(x => (x.username === u || x.phone === u) && x.password === p && x.role === 'teacher');
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    app.init();
                    return true;
                }
                return false;
            },
            logout() {
                currentUser = null;
                localStorage.removeItem('currentUser');
                app.renderLogin();
            }
        };
        
        // ----------------------------------------
        // 4. BUSINESS LOGIC (Học Phí, Điểm Danh)
        // ----------------------------------------

        /**
         * Điều chỉnh số buổi đã đóng (paid) và số buổi nợ (debt)
         * @param {string} studentId - ID Học sinh
         * @param {number} change - Số buổi thay đổi (dương: thêm buổi, âm: trừ buổi/trừ nợ)
         * @param {string} reason - Lý do thay đổi
         * @param {string} date - Ngày giao dịch
         * @param {number} feePerSession - Học phí/buổi (để log)
         * @param {boolean} isAutoDeduct - true nếu là tự động trừ/hoàn khi điểm danh
         * @param {string} type - 'session' (buổi học paid) hoặc 'debt' (buổi nợ)
         */
        function adjustFee(studentId, change, reason, date, feePerSession, isAutoDeduct = false, type = 'session') {
            let fees = db.get('fees');
            // Ensure current object is initialized with debt
            fees[studentId] = fees[studentId] || { current: { paid: 0, remaining: 0, debt: 0 }, history: [] }; 
            let current = fees[studentId].current;
            if (current.debt === undefined) current.debt = 0; 

            let paidBefore = current.paid;
            let debtBefore = current.debt;
            let logChange = 0;
            const day = date || new Date().toISOString().split('T')[0];
            const maxPaid = CONFIG.SESSIONS_PER_COURSE;

            // Tự động: Xử lý điểm danh
            if (isAutoDeduct) { 
                if (change < 0) { // Trừ tự động 1 buổi khi điểm danh Có Mặt (change = -1)
                    if (current.paid > 0) {
                        // Ưu tiên 1: Trừ buổi đã đóng
                        current.paid--;
                        logChange = -1;
                        reason = reason.replace('Tự động: Điểm danh ngày', 'Tự động: Điểm danh (TRỪ PAID) ngày'); 
                    } else { 
                        // LOGIC NỢ HỌC PHÍ (Ghi nhận nợ mới)
                        current.debt++; // Ghi nhận nợ 1 buổi
                        logChange = 0; // Không trừ buổi đã đóng/tiền dư
                        reason = reason.replace('Tự động: Điểm danh ngày', 'Tự động: Điểm danh (NỢ) ngày'); 
                    }
                } else if (change > 0) { // Hoàn lại buổi học (khi chuyển từ có mặt -> vắng)
                    // Ưu tiên 1: Hoàn lại NỢ trước
                    if (current.debt > 0) {
                        current.debt--; // Hoàn lại 1 buổi nợ
                        logChange = 0; // Không thay đổi buổi đã đóng
                        reason = reason.replace('Tự động: Xóa điểm danh ngày', 'Tự động: Xóa điểm danh (HOÀN NỢ) ngày');
                    } else if (current.paid < maxPaid) { 
                        // Ưu tiên 2: Hoàn lại buổi đã đóng
                        current.paid++;
                        logChange = 1;
                        reason = reason.replace('Tự động: Xóa điểm danh ngày', 'Tự động: Xóa điểm danh (HOÀN PAID) ngày');
                    } else { 
                        // Không log nếu không có thay đổi thực tế hoặc không thể hoàn
                        if (change > 0) console.warn('Số buổi đã đóng đạt tối đa. Không thể hoàn lại.');
                        return; 
                    }
                } else { 
                    return; 
                }

            } else { 
                // Logic THỦ CÔNG (thêm/bớt buổi học, bao gồm cả trả nợ)
                if (type === 'debt') { // THỦ CÔNG: Điều chỉnh nợ
                    change = Math.floor(change); // Đảm bảo là số nguyên
                    let newDebt = current.debt + change; 
                    if (newDebt < 0) return alert(`Không thể giảm buổi nợ thêm ${-change} vì số buổi nợ chỉ còn ${current.debt}.`); 
                    current.debt = newDebt;
                    logChange = change; // Log là thay đổi của debt
                    if (change < 0) reason = (reason ? reason : 'Thanh Toán Nợ Thủ Công') + ` (-${-change} buổi nợ)`;
                    else reason = (reason ? reason : 'Tăng Nợ Thủ Công') + ` (+${change} buổi nợ)`;
                } else { // THỦ CÔNG: Thêm/bớt buổi học (paid sessions)
                    change = Math.floor(change); // Đảm bảo là số nguyên
                    let newPaid = current.paid + change;
                    if (newPaid < 0) return alert('Không thể trừ buổi vì số buổi đã đóng không đủ.'); 
                    if (newPaid > maxPaid) return alert(`Không thể đóng thêm ${change} buổi vì số buổi tối đa là ${maxPaid}.`);
                    current.paid = newPaid;
                    logChange = change;
                }
            }
            
            // Log the transaction
            fees[studentId].history.push({
                date: day, 
                change: logChange, 
                feeValue: feePerSession, 
                paidBefore: paidBefore,
                paidAfter: current.paid,
                remainingAfter: current.remaining,
                debtBefore: debtBefore, // CẬP NHẬT LOG
                debtAfter: current.debt, // CẬP NHẬT LOG
                reason: reason 
            });
            
            db.set('fees', fees);

            // Đóng modal sau khi điều chỉnh thủ công
            if (!isAutoDeduct) {
                document.getElementById('modalContainer').innerHTML = '';
                // Lấy filter hiện tại để re-render
                const classFilterFee = document.getElementById('classFilterFee')?.value || 'all';
                const searchFeeQuery = document.getElementById('searchFeeQuery')?.value || '';
                app.renderFees(classFilterFee, searchFeeQuery); // Re-render với filters
            }
        }

        /**
         * Điều chỉnh số tiền dư (remaining)
         */
        function adjustMoney(studentId, moneyChange, reason, date) {
            let fees = db.get('fees');
            // Ensure current object is initialized with debt
            fees[studentId] = fees[studentId] || { current: { paid: 0, remaining: 0, debt: 0 }, history: [] };
            if (!fees[studentId].history) fees[studentId].history = [];
            let current = fees[studentId].current;
            if (current.debt === undefined) current.debt = 0; // Ensure debt exists

            let paidBefore = current.paid;
            let debtBefore = current.debt; // Lấy debt trước khi giao dịch tiền
            const day = date || new Date().toISOString().split('T')[0];
            
            if (moneyChange < 0 && current.remaining + moneyChange < 0) {
                alert('Không thể rút/trừ tiền: Số tiền dư không đủ.');
                return;
            }

            current.remaining += moneyChange;
            
            fees[studentId].history.push({
                date: day, 
                change: moneyChange, 
                feeValue: 0, // Không áp dụng phí/buổi cho giao dịch tiền mặt
                paidBefore: paidBefore,
                paidAfter: current.paid,
                remainingAfter: current.remaining,
                debtBefore: debtBefore, // CẬP NHẬT LOG
                debtAfter: current.debt, // CẬP NHẬT LOG (vẫn giữ nguyên vì đây là giao dịch tiền, không phải buổi)
                reason: reason 
            });
            db.set('fees', fees);
            
            // Đóng modal sau khi điều chỉnh thủ công
            document.getElementById('modalContainer').innerHTML = '';

            // Lấy filter hiện tại để re-render
            const classFilterFee = document.getElementById('classFilterFee')?.value || 'all';
            const searchFeeQuery = document.getElementById('searchFeeQuery')?.value || '';
            app.renderFees(classFilterFee, searchFeeQuery); // Re-render với filters
        }
        
        // ----------------------------------------
        // 3. UI/VIEW LOGIC
        // ----------------------------------------
        const app = {
            init() {
                db.init();
                document.getElementById('authSection').innerHTML = currentUser ?
                    `<div class="flex items-center gap-4">
                        <span class="font-extrabold text-primary-blue"><i class="fas fa-user-circle mr-2"></i>${currentUser.name} (Giáo viên)</span>
                        <button onclick="auth.logout()" class="text-red-600 hover:text-red-800 font-bold p-2 bg-red-100 rounded-lg transition">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </button>
                    </div>` :
                    `<button onclick="app.renderLogin()" class="btn-primary">Đăng Nhập</button>`;
                if (currentUser) this.renderDashboard();
                else this.renderLogin();
            },

            getFormattedDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            },

            renderLogin() {
                document.getElementById('mainContent').innerHTML = `
                    <div class="max-w-md mx-auto card mt-20 text-center border-t-8 border-primary-blue">
                        <i class="fas fa-chalkboard-teacher text-6xl text-primary-blue mb-6"></i>
                        <h2 class="text-3xl font-extrabold mb-8 text-primary-blue">ĐĂNG NHẬP HỆ THỐNG</h2>
                        <input id="user" type="text" class="input-field mb-4" placeholder="Tài khoản (admin)">
                        <input id="pass" type="password" class="input-field mb-6" placeholder="Mật khẩu (123)">
                        <button onclick="handleLogin()" class="btn-primary w-full py-4 text-lg">ĐĂNG NHẬP NGAY</button>
                        <p class="text-sm text-gray-500 mt-4">Chỉ dành cho Giáo viên quản lý.</p>
                    </div>`;
            },

            renderDashboard() {
                const students = db.get('students');
                const stats = this.calculateDashboardStats();

                document.getElementById('mainContent').innerHTML = `
                    <div class="hero-banner relative rounded-xl shadow-2xl">
                        <div class="relative text-white z-10">
                            <h2 class="text-2xl font-medium mb-2 opacity-90">Xin chào, ${currentUser.name}!</h2>
                            <h1 class="text-5xl font-extrabold mb-3 leading-tight">BẢNG ĐIỀU KHIỂN QUẢN LÝ</h1>
                            <p class="text-lg opacity-90">Tầm nhìn tổng quan về trung tâm Toán Cô Huyền.</p>
                            <a href="#stats" class="inline-block mt-4 text-sm font-bold border-b-2 border-secondary-orange hover:text-secondary-orange transition duration-300">
                                Xem thống kê chi tiết <i class="fas fa-arrow-down ml-1"></i>
                            </a>
                        </div>
                    </div>

                    <h3 id="stats" class="text-3xl font-extrabold text-primary-blue mb-8 border-b-4 border-secondary-orange/50 pb-3">THỐNG KÊ HIỆN TẠI</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <div class="card p-8 bg-gradient-to-br from-primary-blue to-blue-600 text-white border-none shadow-xl transition duration-300 hover:shadow-2xl hover:scale-[1.02] cursor-default">
                            <i class="fas fa-users text-5xl mb-4 opacity-70"></i>
                            <p class="text-sm uppercase font-semibold opacity-90">Tổng Học Sinh</p>
                            <p class="text-6xl font-extrabold mt-1">${students.length}</p>
                        </div>
                        <div onclick="app.renderFees()" class="card p-8 bg-gradient-to-br from-accent-green to-green-600 text-white border-none shadow-xl cursor-pointer transition duration-300 hover:shadow-2xl hover:scale-[1.02]">
                            <i class="fas fa-coins text-5xl mb-4 opacity-70"></i>
                            <p class="text-sm uppercase font-semibold opacity-90">Tổng Học Phí Đã Thu</p>
                            <p class="text-4xl font-extrabold mt-1">${stats.totalRevenue.toLocaleString('vi-VN')}₫</p>
                        </div>
                        <div onclick="app.renderAttendance()" class="card p-8 bg-gradient-to-br from-secondary-orange to-orange-600 text-white border-none shadow-xl cursor-pointer transition duration-300 hover:shadow-2xl hover:scale-[1.02]">
                            <i class="fas fa-calendar-check text-5xl mb-4 opacity-70"></i>
                            <p class="text-sm uppercase font-semibold opacity-90">Học Sinh Có Mặt Hôm Nay</p>
                            <p class="text-6xl font-extrabold mt-1">${stats.todayAttendance}</p>
                        </div>
                    </div>

                    <h3 class="text-3xl font-extrabold text-primary-blue mb-8 border-b-4 border-secondary-orange/50 pb-3">TRUY CẬP NHANH</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <button onclick="app.renderStudentList()" class="card flex flex-col items-center justify-center p-6 bg-light-bg hover:bg-blue-100 transition duration-300 shadow-md border-l-4 border-primary-blue hover:shadow-lg">
                            <i class="fas fa-user-friends text-5xl text-primary-blue mb-3"></i>
                            <span class="font-bold text-lg">Quản Lý Học Sinh</span>
                            <span class="text-sm text-gray-600">Thêm, sửa, xóa học sinh.</span>
                        </button>
                        <button onclick="app.renderAttendance()" class="card flex flex-col items-center justify-center p-6 bg-light-bg hover:bg-orange-100 transition duration-300 shadow-md border-l-4 border-secondary-orange hover:shadow-lg">
                            <i class="fas fa-clipboard-check text-5xl text-secondary-orange mb-3"></i>
                            <span class="font-bold text-lg">Điểm Danh</span>
                            <span class="text-sm text-gray-600">Ghi nhận buổi học.</span>
                        </button>
                        <button onclick="app.renderFees()" class="card flex flex-col items-center justify-center p-6 bg-light-bg hover:bg-green-100 transition duration-300 shadow-md border-l-4 border-accent-green hover:shadow-lg">
                            <i class="fas fa-file-invoice-dollar text-5xl text-accent-green mb-3"></i>
                            <span class="font-bold text-lg">Quản Lý Học Phí</span>
                            <span class="text-sm text-gray-600">Theo dõi buổi học đã đóng.</span>
                        </button>
                        <button onclick="app.renderReports()" class="card flex flex-col items-center justify-center p-6 bg-light-bg hover:bg-gray-200 transition duration-300 shadow-md border-l-4 border-gray-400 hover:shadow-lg">
                            <i class="fas fa-chart-line text-5xl text-gray-500 mb-3"></i>
                            <span class="font-bold text-lg">Báo Cáo Thống Kê</span>
                            <span class="text-sm text-gray-600">Theo dõi tiến trình.</span>
                        </button>
                    </div>
                `;
            },

            // ─── QUẢN LÝ HỌC SINH (có thể thêm/sửa/xóa) ───
            renderStudentList(classFilter = 'all') { // Đã thêm tham số classFilter
                let students = db.get('students').sort((a, b) => a.name.localeCompare(b.name, 'vi'));
                // Logic Lọc theo Lớp
                if (classFilter !== 'all') {
                    students = students.filter(s => s.classId === classFilter);
                }

                let classOptions = CLASSES.map(c => `<option value="${c}" ${c === classFilter ? 'selected' : ''}>${c === '1-1' ? 'Kèm 1-1' : `Lớp ${c}`}</option>`).join('');
                let rows = students.map((s, i) => `
                    <tr id="student-${s.id}">
                        <td class="text-center w-16">${i+1}</td>
                        <td class="font-semibold text-primary-blue min-w-[150px]">${s.name}</td>
                        <td class="text-gray-600 w-32">${s.phone || '<span class="italic text-red-400">Chưa có</span>'}</td>
                        <td class="font-bold ${s.classId === '1-1' ? 'text-one-to-one-fee' : 'text-secondary-orange'} w-24">${s.classId === '1-1' ? 'KÈM 1-1' : s.classId}</td>
                        <td class="text-center w-32">
                            <button onclick="showEditStudentModal('${s.id}', '${s.name.replace(/'/g, "\\'")}', '${s.phone}', '${s.classId}')" class="text-white bg-primary-blue hover:bg-blue-700 text-sm px-3 py-1 rounded-full transition mr-2"><i class="fas fa-edit"></i> Sửa</button>
                            <button onclick="deleteStudent('${s.id}')" class="text-red-600 hover:text-red-800 text-lg"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('mainContent').innerHTML = `
                    <div class="card border-t-8 border-primary-blue">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-4xl font-extrabold text-primary-blue">DANH SÁCH HỌC SINH</h2>
                            <button onclick="app.exportStudentList(document.getElementById('classFilter').value)" class="btn-primary !bg-accent-green hover:!bg-green-700">
                                <i class="fas fa-file-excel mr-2"></i> Xuất Excel
                            </button>
                        </div>
                        
                        <div class="mb-6 p-4 bg-blue-50 rounded-xl shadow-inner border border-blue-200 flex items-center gap-4">
                            <label for="classFilter" class="font-bold text-lg text-primary-blue"><i class="fas fa-filter mr-2"></i> LỌC THEO LỚP:</label>
                            <select id="classFilter" onchange="app.renderStudentList(this.value)" class="input-field !w-auto !py-2 !px-4 bg-white font-bold text-secondary-orange">
                                <option value="all" ${classFilter === 'all' ? 'selected' : ''}>Tất cả các lớp</option>
                                ${classOptions}
                            </select>
                            <span class="ml-auto font-bold text-primary-blue">Tìm thấy: <span class="text-secondary-orange">${students.length}</span> học sinh</span>
                        </div>
                        
                        <div class="mb-8 p-4 bg-light-bg rounded-xl shadow-inner border border-gray-200">
                            <h3 class="text-xl font-bold mb-4 text-secondary-orange">THÊM HỌC SINH MỚI</h3>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                                <input id="newName" placeholder="Họ tên" class="input-field col-span-1 md:col-span-2">
                                <input id="newPhone" placeholder="SĐT PH" class="input-field col-span-1">
                                <select id="newClass" class="input-field col-span-1">${CLASSES.map(c => `<option value="${c}">${c === '1-1' ? 'Kèm 1-1' : `Lớp ${c}`}</option>`).join('')}</select>
                                <button onclick="addStudent()" class="btn-secondary col-span-1 !py-3">THÊM</button>
                            </div>
                        </div>

                        <div class="overflow-x-auto rounded-xl shadow-xl border border-gray-200">
                            <table class="responsive-table">
                                <thead>
                                    <tr>
                                        <th class="text-center">STT</th>
                                        <th>Họ Tên</th>
                                        <th>SĐT PH</th>
                                        <th>Lớp</th>
                                        <th class="text-center">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>${rows || '<tr><td colspan="5" class="text-center py-8 text-gray-500">Chưa có học sinh nào.</td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            // ─── ĐIỂM DANH ───
            renderAttendance(selectedDate = new Date().toISOString().split('T')[0], classFilter = 'all') { // Thêm selectedDate và classFilter
                const students = db.get('students').sort((a, b) => a.name.localeCompare(b.name, 'vi'));
                const fees = db.get('fees'); // Lấy dữ liệu học phí

                let filteredStudents = students;
                if (classFilter !== 'all') {
                    filteredStudents = students.filter(s => s.classId === classFilter);
                }

                const att = db.get('attendance')[selectedDate] || {};
                let totalPresent = Object.values(att).filter(x => x && x.status === 'present').length;
                
                // FIX: Thêm tùy chọn "Tất cả các lớp" cho bộ lọc Điểm danh
                let classOptions = `<option value="all" ${classFilter === 'all' ? 'selected' : ''}>Tất cả các lớp</option>` + 
                    CLASSES.map(c => `<option value="${c}" ${c === classFilter ? 'selected' : ''}>${c === '1-1' ? 'Kèm 1-1' : `Lớp ${c}`}</option>`).join('');
                
                let rows = filteredStudents.map((s, i) => {
                    const status = att[s.id]?.status || 'absent';
                    const note = att[s.id]?.note || '';
                    const isPresent = status === 'present';
                    // FIX: Đảm bảo có debt: 0 trong feeData
                    const feeData = fees[s.id]?.current || { paid: 0, remaining: 0, debt: 0 }; 
                    const maxPaid = CONFIG.SESSIONS_PER_COURSE;
                    const feePerSession = getFeeByClass(s.classId); // Lấy phí theo loại lớp

                    let feeStatusHtml = '';
                    if (feeData.paid <= 0 && feeData.debt <= 0) {
                        feeStatusHtml = '<span class="bg-red-100 text-red-600 font-bold px-3 py-1 rounded-full text-xs">Chưa đóng buổi nào</span>';
                    } else if (feeData.paid < maxPaid) {
                         feeStatusHtml = `<span class="bg-yellow-100 text-secondary-orange font-bold px-3 py-1 rounded-full text-xs">Thiếu ${maxPaid - feeData.paid} buổi</span>`;
                    } else {
                        feeStatusHtml = '<span class="bg-green-100 text-accent-green font-bold px-3 py-1 rounded-full text-xs">Đủ 10 buổi</span>';
                    }
                    
                    return `
                        <tr id="att-${s.id}">
                            <td class="text-center w-16">${i+1}</td>
                            <td class="font-bold ${isPresent ? 'text-primary-blue' : 'text-gray-600'}">${s.name} <span class="text-xs text-gray-500 font-normal ml-1">(${s.classId === '1-1' ? 'Kèm 1-1' : `Lớp ${s.classId}`})</span></td>
                            <td class="text-center font-extrabold w-32">${feeData.paid} / ${maxPaid} <span class="${feeData.debt > 0 ? 'bg-red-500 text-white font-bold px-2 py-0.5 rounded-full text-xs ml-1' : 'text-gray-400 font-normal'}">${feeData.debt > 0 ? `NỢ ${feeData.debt}` : ''}</span></td>
                            <td class="text-center min-w-[120px]">${feeStatusHtml}</td> 
                            <td class="text-center w-28">
                                <button onclick="toggleAttend('${s.id}', 'present', '${selectedDate}')" class="text-sm font-bold w-full p-2 rounded-lg transition ${isPresent ? 'bg-accent-green text-white shadow-md' : 'bg-gray-200 text-gray-500 hover:bg-green-100'}">
                                    <i class="fas fa-check"></i> Có mặt
                                </button>
                            </td>
                            <td class="text-center w-28">
                                <button onclick="toggleAttend('${s.id}', 'absent', '${selectedDate}')" class="text-sm font-bold w-full p-2 rounded-lg transition ${!isPresent ? 'bg-red-500 text-white shadow-md' : 'bg-gray-200 text-gray-500 hover:bg-red-100'}">
                                    <i class="fas fa-times"></i> Vắng
                                </button>
                            </td>
                            <td><input type="text" value="${note}" placeholder="Ghi chú (Ví dụ: Có phép, Bệnh)" class="input-field !p-2 !text-sm" onblur="saveNote('${s.id}', this.value, '${selectedDate}')"></td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('mainContent').innerHTML = `
                    <div class="card border-t-8 border-secondary-orange">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-4xl font-extrabold text-primary-blue">QUẢN LÝ ĐIỂM DANH</h2>
                            <button onclick="app.exportAttendance(document.getElementById('attendanceDate').value, document.getElementById('classFilterAtt').value)" class="btn-primary !bg-accent-green hover:!bg-green-700">
                                <i class="fas fa-file-excel mr-2"></i> Xuất Excel
                            </button>
                        </div>
                    
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 p-4 bg-yellow-50 rounded-xl shadow-inner border border-yellow-200">
                            <div class="flex items-center gap-4 mb-3 md:mb-0">
                                <label for="attendanceDate" class="font-bold text-lg text-primary-blue"><i class="fas fa-calendar-alt mr-2"></i> CHỌN NGÀY:</label>
                                <input type="date" id="attendanceDate" value="${selectedDate}" onchange="app.renderAttendance(this.value, document.getElementById('classFilterAtt').value)" class="input-field !w-auto !py-2 !px-4 bg-white font-bold text-secondary-orange">
                            </div>
                            <div class="flex items-center gap-4">
                                <label for="classFilterAtt" class="font-bold text-lg text-secondary-orange"><i class="fas fa-filter mr-2"></i> LỌC LỚP:</label>
                                <select id="classFilterAtt" onchange="app.renderAttendance(document.getElementById('attendanceDate').value, this.value)" class="input-field !w-auto !py-2 !px-4 bg-white font-bold">
                                    ${classOptions}
                                </select>
                                <span class="font-bold text-primary-blue ml-2">Số HS: <span class="text-secondary-orange">${filteredStudents.length}</span></span>
                            </div>
                        </div>

                        <div class="overflow-x-auto rounded-xl shadow-xl border border-gray-200">
                            <table class="responsive-table">
                                <thead>
                                    <tr>
                                        <th class="text-center">STT</th>
                                        <th>Họ Tên</th>
                                        <th class="text-center">Buổi Đã Đóng (10)</th>
                                        <th class="text-center">Trạng Thái Học Phí</th> 
                                        <th class="text-center" colspan="2">Tình Trạng (Chọn)</th>
                                        <th>Ghi chú</th>
                                    </tr>
                                </thead>
                                <tbody>${rows || '<tr><td colspan="7" class="text-center py-8 text-gray-500">Chưa có học sinh nào để điểm danh.</td></tr>'}</tbody> 
                            </table>
                        </div>
                        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center bg-primary-blue text-white p-4 rounded-xl shadow-lg">
                            <p class="text-xl font-bold mb-2 sm:mb-0">TỔNG KẾT NGÀY ${app.getFormattedDate(selectedDate)}:</p>
                            <p class="text-3xl font-extrabold text-secondary-orange">${totalPresent} / ${filteredStudents.length} học sinh Có mặt</p>
                        </div>
                    </div>
                `;
            },

            // ─── QUẢN LÝ HỌC PHÍ ───
            renderFees(classFilter = 'all', searchQuery = '') { // MODIFIED: Added filters
                const students = db.get('students').sort((a, b) => a.name.localeCompare(b.name, 'vi'));
                const fees = db.get('fees');
                const maxPaid = CONFIG.SESSIONS_PER_COURSE;

                // --- NEW FILTERING LOGIC ---
                let filteredStudents = students;
                if (classFilter !== 'all') {
                    filteredStudents = filteredStudents.filter(s => s.classId === classFilter);
                }
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filteredStudents = filteredStudents.filter(s => 
                        s.name.toLowerCase().includes(query) || s.phone.includes(query) 
                    );
                }
                // --- END FILTERING LOGIC ---

                let classOptions = CLASSES.map(c => `<option value="${c}" ${c === classFilter ? 'selected' : ''}>${c === '1-1' ? 'Kèm 1-1' : `Lớp ${c}`}</option>`).join('');
                
                let rows = filteredStudents.map(s => { // Using filteredStudents
                    // FIX: Đảm bảo có debt: 0 trong data
                    const data = fees[s.id]?.current || { paid: 0, remaining: 0, debt: 0 }; 
                    const feePerSession = getFeeByClass(s.classId); // Using getFeeByClass
                    const paidAmount = data.paid * feePerSession;

                    const feeDisplay = s.classId === '1-1' ? 
                        `<span class="text-one-to-one-fee font-bold">${feePerSession.toLocaleString('vi-VN')}₫</span>` : 
                        `<span class="text-primary-blue font-bold">${feePerSession.toLocaleString('vi-VN')}₫</span>`;

                    return `
                        <tr>
                            <td class="font-bold text-gray-800 min-w-[150px]">${s.name}</td>
                            <td>${s.classId === '1-1' ? 'Kèm 1-1' : s.classId}</td>
                            <td class="text-right">${feeDisplay}</td>
                            <td class="text-center font-extrabold text-2xl text-primary-blue">${data.paid} / ${maxPaid} 
                                <span class="${(data.debt || 0) > 0 ? 'bg-red-500 text-white font-bold px-2 py-0.5 rounded-full text-xs ml-1' : 'text-gray-400 font-normal'}">${(data.debt || 0) > 0 ? `NỢ ${(data.debt || 0)}` : ''}</span>
                            </td>
                            <td class="text-right font-bold text-accent-green">${paidAmount.toLocaleString('vi-VN')}₫</td>
                            <td class="text-right min-w-[120px]">
                                ${data.remaining > 0 ? 
                                    `<span class="bg-secondary-orange/10 text-secondary-orange font-bold px-3 py-1 rounded-full">${data.remaining.toLocaleString('vi-VN')}₫</span>` : 
                                    `<span class="text-gray-500 italic">0₫</span>`
                                }
                            </td>
                            <td class="text-center w-32">
                                <button onclick="showAdjustFeeModal('${s.id}', '${s.name.replace(/'/g, "\\'")}', '${s.classId}')" class="text-white bg-primary-blue hover:bg-blue-700 text-sm px-3 py-1 rounded-full transition"><i class="fas fa-plus-circle mr-1"></i> Điều Chỉnh</button>
                                <button onclick="showFeeHistoryModal('${s.id}', '${s.name.replace(/'/g, "\\'")}')" class="text-gray-500 hover:text-primary-blue text-sm px-3 py-1 rounded-full transition"><i class="fas fa-history"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('mainContent').innerHTML = `
                    <div class="card border-t-8 border-accent-green">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-4xl font-extrabold text-accent-green">QUẢN LÝ HỌC PHÍ</h2>
                            <button onclick="app.exportFees(document.getElementById('classFilterFee').value, document.getElementById('searchFeeQuery').value)" class="btn-primary !bg-primary-blue hover:!bg-blue-700">
                                <i class="fas fa-file-excel mr-2"></i> Xuất Excel
                            </button>
                        </div>
                        <p class="text-lg text-gray-700 mb-8 font-semibold">Theo dõi số buổi học đã đóng, tiền dư và tình trạng nợ học phí của học sinh.</p>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 p-4 bg-green-50 rounded-xl shadow-inner border border-green-200">
                            <div class="col-span-1">
                                <label for="classFilterFee" class="font-bold text-sm text-primary-blue">LỌC THEO LỚP:</label>
                                <select id="classFilterFee" onchange="app.renderFees(this.value, document.getElementById('searchFeeQuery').value)" class="input-field !py-2 !px-4 bg-white font-bold text-secondary-orange">
                                    <option value="all" ${classFilter === 'all' ? 'selected' : ''}>Tất cả các lớp</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label for="searchFeeQuery" class="font-bold text-sm text-primary-blue">TÌM KIẾM (Tên/SĐT):</label>
                                <input type="text" id="searchFeeQuery" value="${searchQuery}" placeholder="Tìm kiếm học sinh..." class="input-field !py-2 !px-4 bg-white" oninput="app.renderFees(document.getElementById('classFilterFee').value, this.value)">
                            </div>
                            <div class="col-span-1 flex items-end">
                                <span class="font-bold text-primary-blue text-lg w-full p-2 bg-green-100 rounded-lg">Tìm thấy: <span class="text-secondary-orange">${filteredStudents.length}</span> học sinh</span>
                            </div>
                        </div>

                        <div class="overflow-x-auto rounded-xl shadow-xl border border-gray-200">
                            <table class="responsive-table">
                                <thead>
                                    <tr>
                                        <th>Học sinh</th>
                                        <th>Loại Lớp</th>
                                        <th class="text-right">Học Phí/Buổi</th>
                                        <th class="text-center">Buổi Đã Đóng (${maxPaid})</th>
                                        <th class="text-right">Tổng Tiền Đã Thu</th>
                                        <th class="text-right">Tiền Dư</th>
                                        <th class="text-center">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody>${rows || '<tr><td colspan="7" class="text-center py-8 text-gray-500">Không tìm thấy học sinh nào.</td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            // ─── BÁO CÁO ───
            renderReports() {
                const students = db.get('students');
                const attendance = db.get('attendance');
                
                // 1. Calculate stats based on actual attendance
                let totalPresentSessions = 0;
                let totalRevenueBasedOnAttendance = 0;
                const sessionsByClass = {};
                CLASSES.forEach(c => sessionsByClass[c] = { count: 0, revenue: 0 });

                for (const day in attendance) {
                    const dailyAtt = attendance[day];
                    for (const studentId in dailyAtt) {
                        if (dailyAtt[studentId].status === 'present') {
                            const student = students.find(s => s.id === studentId);
                            if (student) {
                                const fee = getFeeByClass(student.classId);
                                const classId = student.classId;
                                sessionsByClass[classId] = sessionsByClass[classId] || { count: 0, revenue: 0 };
                                sessionsByClass[classId].count++;
                                sessionsByClass[classId].revenue += fee;
                                totalPresentSessions++;
                                totalRevenueBasedOnAttendance += fee;
                            }
                        }
                    }
                }

                // 2. Prepare Class Report Table
                const classReportRows = Object.entries(sessionsByClass)
                    .sort(([classA], [classB]) => classA.localeCompare(classB))
                    .map(([classId, data]) => `
                        <tr>
                            <td class="font-bold ${classId === '1-1' ? 'text-one-to-one-fee' : 'text-primary-blue'}">${classId === '1-1' ? 'KÈM 1-1' : `Lớp ${classId}`}</td>
                            <td class="text-center font-extrabold text-2xl text-secondary-orange">${data.count}</td>
                            <td class="text-right font-bold text-accent-green">${data.revenue.toLocaleString('vi-VN')}₫</td>
                        </tr>
                    `).join('');

                document.getElementById('mainContent').innerHTML = `
                    <div class="card border-t-8 border-gray-400">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-4xl font-extrabold text-primary-blue">BÁO CÁO THỐNG KÊ</h2>
                            <button onclick="app.exportReports()" class="btn-primary !bg-primary-blue hover:!bg-blue-700">
                                <i class="fas fa-file-excel mr-2"></i> Xuất Excel
                            </button>
                        </div>
                        <p class="text-lg text-gray-700 mb-8 font-semibold">Phân tích tiến trình dựa trên số buổi học đã diễn ra và doanh thu tương ứng.</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                            <div class="card p-5 bg-blue-50 border-primary-blue/50 border shadow-md">
                                <p class="text-sm uppercase font-semibold text-primary-blue">Tổng Buổi Điểm Danh (Đã học)</p>
                                <p class="text-4xl font-extrabold text-primary-blue mt-1">${totalPresentSessions}</p>
                            </div>
                            <div class="card p-5 bg-green-50 border-accent-green/50 border shadow-md md:col-span-2">
                                <p class="text-sm uppercase font-semibold text-accent-green">Tổng Doanh Thu Tạm Tính (Dựa trên số buổi)</p>
                                <p class="text-4xl font-extrabold text-accent-green mt-1">${totalRevenueBasedOnAttendance.toLocaleString('vi-VN')}₫</p>
                            </div>
                        </div>

                        <h3 class="text-3xl font-extrabold text-secondary-orange mb-6 border-b-4 border-gray-400/50 pb-2">PHÂN TÍCH THEO LỚP</h3>

                        <div class="overflow-x-auto rounded-xl shadow-xl border border-gray-200">
                            <table class="responsive-table">
                                <thead>
                                    <tr>
                                        <th>Lớp</th>
                                        <th class="text-center">Số Buổi Đã Học</th>
                                        <th class="text-right">Doanh Thu Tạm Tính</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${classReportRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },
            
            // ─── CHỨC NĂNG TÍNH TOÁN ───
            calculateDashboardStats() {
                const students = db.get('students');
                const fees = db.get('fees');
                const attendance = db.get('attendance');
                const today = new Date().toISOString().split('T')[0];

                // 1. Total Revenue Calculation
                let totalRevenue = 0;
                for (const studentId in fees) {
                    const studentFees = fees[studentId].history;
                    if (studentFees) {
                        // Total revenue = sum of positive money transactions + sum of paid sessions * fee/session
                        // For simplicity and accuracy (since money/sessions are separate):
                        // We sum the 'change' in all history entries that represent money inflow (paid sessions are calculated on top)
                        // This logic relies on the assumption that only 'remaining_plus' and 'paid' transactions represent new revenue.
                        
                        // Current simplified approach in the original code is likely to calculate Total Paid Amount based on current paid sessions:
                        const student = students.find(s => s.id === studentId);
                        if (student) {
                            const currentFee = fees[studentId].current;
                            const feePerSession = getFeeByClass(student.classId);
                            // Summing up all historical positive money changes (remaining_plus) and session payments
                            const studentRevenue = studentFees.reduce((sum, item) => {
                                // Nếu là giao dịch tiền dương (remaining_plus)
                                if (item.feeValue === 0 && item.change > 0) {
                                    return sum + item.change;
                                }
                                // Nếu là giao dịch buổi dương (paid)
                                if (item.feeValue > 0 && item.change > 0) {
                                    return sum + (item.change * item.feeValue);
                                }
                                return sum;
                            }, 0);
                            
                            // To be safer and more accurate, we should iterate over all history logs
                            // and sum the *actual cash/session value* received (ignoring automated deducts/reversals).
                            // The original code uses a simple paid*fee model, let's stick to calculating total cash in:

                            let calculatedRevenue = 0;
                            fees[studentId].history.forEach(item => {
                                // Rule: Only count positive changes in sessions (paid) or money (remaining)
                                if (item.feeValue > 0 && item.change > 0) { // New paid sessions
                                    calculatedRevenue += item.change * item.feeValue;
                                } else if (item.feeValue === 0 && item.change > 0) { // New cash added (remaining_plus)
                                    calculatedRevenue += item.change;
                                }
                            });

                            totalRevenue += calculatedRevenue;
                        }
                    }
                }

                // 2. Today's Attendance
                const todayAtt = attendance[today] || {};
                let todayAttendance = Object.values(todayAtt).filter(x => x && x.status === 'present').length;

                return { totalRevenue, todayAttendance };
            }
        };


        // ----------------------------------------
        // 5. GLOBAL FUNCTIONS
        // ----------------------------------------

        function handleLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            if (!u || !p) return alert('Vui lòng nhập tài khoản và mật khẩu.');
            if (auth.login(u, p)) {
                // Success: app.init() handles rendering dashboard
            } else {
                alert('Sai tên đăng nhập hoặc mật khẩu.');
            }
        }
        
        function addStudent() {
            const name = document.getElementById('newName').value.trim();
            const phone = document.getElementById('newPhone').value.trim();
            const classId = document.getElementById('newClass').value;

            if (!name) return alert('Vui lòng nhập tên học sinh.');

            let students = db.get('students');
            const newStudent = {
                id: `s_${Date.now()}`,
                name: name,
                phone: phone,
                classId: classId
            };
            students.push(newStudent);
            db.set('students', students);

            // Clear inputs
            document.getElementById('newName').value = '';
            document.getElementById('newPhone').value = '';
            app.renderStudentList(document.getElementById('classFilter').value);
        }

        // FIX: Hàm xóa học sinh đã được sửa để xóa cả dữ liệu fees và attendance
        function deleteStudent(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa học sinh này không? Việc này sẽ xóa toàn bộ dữ liệu học phí và điểm danh của học sinh đó!')) return;
            
            // 1. Xóa học sinh khỏi danh sách
            let students = db.get('students').filter(s => s.id !== id);
            db.set('students', students);

            // 2. FIX: Xóa dữ liệu học phí (để giảm doanh thu tương ứng)
            let fees = db.get('fees');
            delete fees[id];
            db.set('fees', fees);

            // 3. Xóa dữ liệu điểm danh
            let attendance = db.get('attendance');
            for (const date in attendance) {
                if (attendance[date][id]) {
                    delete attendance[date][id];
                }
            }
            db.set('attendance', attendance);
            
            // Re-render the list
            app.renderStudentList(document.getElementById('classFilter').value);
        }

        function showEditStudentModal(id, name, phone, classId) {
            let classOptions = CLASSES.map(c => `<option value="${c}" ${c === classId ? 'selected' : ''}>${c === '1-1' ? 'Kèm 1-1' : `Lớp ${c}`}</option>`).join('');
            document.getElementById('modalContainer').innerHTML = `
                <div class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 flex items-center justify-center z-[1001]" onclick="this.remove()">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
                        <h3 class="text-2xl font-bold text-primary-blue mb-6 border-b pb-2"><i class="fas fa-user-edit mr-2"></i> Sửa Thông Tin Học Sinh</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Họ Tên</label>
                                <input type="text" id="editName" class="input-field" value="${name}">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Số Điện Thoại PH</label>
                                <input type="text" id="editPhone" class="input-field" value="${phone}">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700">Lớp</label>
                                <select id="editClassId" class="input-field">${classOptions}</select>
                            </div>
                            <button onclick="saveStudentEdit('${id}')" class="w-full btn-primary !py-3">Lưu Thay Đổi</button>
                        </div>
                    </div>
                </div>`;
        }

        function saveStudentEdit(id) {
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const classId = document.getElementById('editClassId').value;

            if (!name) return alert('Vui lòng nhập tên học sinh.');

            let students = db.get('students');
            const student = students.find(s => s.id === id);
            if (student) {
                student.name = name;
                student.phone = phone;
                student.classId = classId;
                db.set('students', students);
            }

            document.getElementById('modalContainer').innerHTML = '';
            app.renderStudentList(document.getElementById('classFilter').value);
        }

        function toggleAttend(id, status, date) {
            const day = date; // Sử dụng ngày được chọn
            const students = db.get('students');
            const student = students.find(s => s.id === id);
            const feePerSession = getFeeByClass(student.classId); // Lấy phí theo loại lớp

            const att = db.get('attendance');
            if (!att[day]) att[day] = {};

            const oldStatus = att[day][id]?.status;
            let note = att[day][id]?.note || '';

            if (status === 'present') {
                if (oldStatus !== 'present') { // Nếu trước đó không phải CÓ MẶT
                    // Trừ tự động 1 buổi đã đóng/ghi nợ (isAutoDeduct = true)
                    adjustFee(id, -1, `Tự động: Điểm danh ngày ${app.getFormattedDate(day)}`, day, feePerSession, true); 
                }
                att[day][id] = { status: 'present', note };
            } else { // Đánh dấu VẮNG (absent)
                if (oldStatus === 'present') { // Nếu trước đó là CÓ MẶT
                    // Hoàn lại 1 buổi đã đóng/hoàn nợ (isAutoDeduct = true)
                    adjustFee(id, 1, `Tự động: Xóa điểm danh ngày ${app.getFormattedDate(day)}`, day, feePerSession, true);
                }
                att[day][id] = { status: 'absent', note };
            }
            db.set('attendance', att);
            
            // Re-render với ngày và bộ lọc hiện tại
            const classFilterAtt = document.getElementById('classFilterAtt')?.value || 'all';
            app.renderAttendance(day, classFilterAtt);
        }

        function saveNote(id, note, date) {
            const day = date; // Sử dụng ngày được chọn
            const att = db.get('attendance');
            if (!att[day]) att[day] = {}; // If the record doesn't exist, create it with default 'absent' status
            if (!att[day][id]) att[day][id] = { status: 'absent' };
            att[day][id].note = note.trim();
            db.set('attendance', att);
            // No need to re-render the whole page, only updating the note
        }

        // FIX: Hàm điều chỉnh học phí Modal đã được cập nhật để bao gồm NỢ
        function showAdjustFeeModal(studentId, studentName, classId) { 
            const today = new Date().toISOString().split('T')[0];
            const feeValue = getFeeByClass(classId); // Lấy phí theo loại lớp
            const className = classId === '1-1' ? 'Kèm 1-1' : `Lớp ${classId}`;
            const feeData = db.get('fees')[studentId]?.current || { paid: 0, remaining: 0, debt: 0 }; // Lấy dữ liệu NỢ
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 flex items-center justify-center z-[1001]" onclick="this.remove()">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
                        <h3 class="text-2xl font-bold text-primary-blue mb-4"><i class="fas fa-money-check-alt mr-2"></i> Điều Chỉnh Học Phí</h3>
                        <p class="text-lg font-extrabold text-gray-800 mb-2">${studentName} (<span class="${classId === '1-1' ? 'text-one-to-one-fee' : 'text-secondary-orange'}">${className}</span>)</p>
                        
                        <div class="bg-gray-100 p-3 rounded-lg text-sm mb-4">
                            <p class="font-bold text-primary-blue">Buổi Đã Đóng: <span class="text-secondary-orange">${feeData.paid}</span></p>
                            <p class="font-bold text-red-600">Buổi Đang Nợ: <span class="text-red-600">${feeData.debt}</span></p>
                            <p class="font-bold text-accent-green">Tiền Dư: <span class="text-accent-green">${feeData.remaining.toLocaleString('vi-VN')}₫</span></p>
                            <p class="text-gray-500">Học phí/buổi: ${feeValue.toLocaleString('vi-VN')}₫</p>
                        </div>

                        <input type="date" id="feeDate" value="${today}" class="input-field mb-3">
                        <input type="text" id="feeReason" placeholder="Lý do (Ví dụ: Chuyển khoản, Buổi bù)" class="input-field mb-5">
                        
                        <h4 class="text-lg font-bold text-secondary-orange mb-3 mt-5 border-b pb-1">ĐIỀU CHỈNH BUỔI ĐÃ ĐÓNG (PAID)</h4>
                        <div class="flex gap-2">
                            <input type="number" id="paidValueInput" placeholder="Số buổi (dương)" class="input-field !w-1/2">
                            <button onclick="handleFeeAdjustment('${studentId}', ${feeValue}, 'paid')" class="btn-secondary !py-2 !w-1/2">Đóng Thêm Buổi</button>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <input type="number" id="minusPaidValueInput" placeholder="Số buổi (dương)" class="input-field !w-1/2">
                            <button onclick="handleFeeAdjustment('${studentId}', ${feeValue}, 'minus_session')" class="btn-primary !bg-red-500 hover:!bg-red-700 !py-2 !w-1/2">Trừ Buổi Đã Đóng</button>
                        </div>

                        <h4 class="text-lg font-bold text-red-600 mb-3 mt-5 border-b pb-1">ĐIỀU CHỈNH BUỔI NỢ (DEBT)</h4>
                        <div class="flex gap-2">
                            <input type="number" id="debtValueInput" placeholder="Số buổi (dương)" class="input-field !w-1/2">
                            <button onclick="handleFeeAdjustment('${studentId}', ${feeValue}, 'pay_debt')" class="btn-secondary !py-2 !w-1/2 !bg-red-500 hover:!bg-red-700">THANH TOÁN NỢ (-Buổi Nợ)</button>
                        </div>
                        
                        <h4 class="text-lg font-bold text-accent-green mb-3 mt-5 border-b pb-1">ĐIỀU CHỈNH TIỀN DƯ (REMAINING)</h4>
                        <div class="flex gap-2">
                            <input type="number" id="moneyValueInput" placeholder="Số tiền (VND)" class="input-field !w-1/2">
                            <button onclick="handleFeeAdjustment('${studentId}', ${feeValue}, 'remaining_plus')" class="btn-secondary !bg-accent-green hover:!bg-green-700 !py-2 !w-1/2">Nạp Thêm Tiền Dư</button>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <input type="number" id="moneyMinusValueInput" placeholder="Số tiền (VND)" class="input-field !w-1/2">
                            <button onclick="handleFeeAdjustment('${studentId}', ${feeValue}, 'remaining_minus')" class="btn-primary !bg-red-500 hover:!bg-red-700 !py-2 !w-1/2">Rút Tiền Dư</button>
                        </div>
                    </div>
                </div>`;
        }

        // FIX: Hàm xử lý điều chỉnh phí đã được cập nhật để xử lý 'pay_debt'
        function handleFeeAdjustment(studentId, feeValue, type) {
            let valueInput;
            if (type === 'paid') {
                valueInput = document.getElementById('paidValueInput').value.trim();
            } else if (type === 'minus_session') {
                valueInput = document.getElementById('minusPaidValueInput').value.trim();
            } else if (type === 'pay_debt') { // NEW: Handle Pay Debt
                valueInput = document.getElementById('debtValueInput').value.trim();
            } else if (type === 'remaining_plus') {
                valueInput = document.getElementById('moneyValueInput').value.trim();
            } else if (type === 'remaining_minus') {
                valueInput = document.getElementById('moneyMinusValueInput').value.trim();
            } else {
                return;
            }
            
            const date = document.getElementById('feeDate').value;
            const reason = document.getElementById('feeReason').value.trim() || type;

            if (!valueInput || isNaN(Number(valueInput)) || Number(valueInput) <= 0) return alert('Vui lòng nhập giá trị hợp lệ (số nguyên dương > 0).');

            let change = 0;
            let moneyChange = 0;
            let finalFeeValue = feeValue; // Mức phí/buổi
            let absValue = Math.floor(Number(valueInput));

            if (type === 'paid') {
                change = absValue; // Số buổi đóng thêm
                if (change < 1) return alert('Số buổi đóng thêm phải là số nguyên dương.');
                adjustFee(studentId, change, reason, date, finalFeeValue);
            } else if (type === 'minus_session') {
                change = -absValue; // Số buổi bị trừ (là số âm)
                if (change > -1) return alert('Số buổi bị trừ phải là số nguyên dương.');
                adjustFee(studentId, change, reason, date, finalFeeValue);
            } else if (type === 'pay_debt') { // NEW: Pay Debt
                change = -absValue; // Trừ buổi nợ (change là âm)
                if (change > -1) return alert('Số buổi nợ được thanh toán phải là số nguyên dương.');
                adjustFee(studentId, change, reason, date, finalFeeValue, false, 'debt');
            } else if (type === 'remaining_plus') {
                moneyChange = Number(valueInput); // Tiền nạp thêm
                adjustMoney(studentId, moneyChange, reason, date);
            } else if (type === 'remaining_minus') {
                moneyChange = -Number(valueInput); // Tiền rút ra (là số âm)
                adjustMoney(studentId, moneyChange, reason, date);
            }
        }
        
        // ─── CHỨC NĂNG EXPORT EXCEL ───
        /** * Chuyển đổi mảng object sang CSV và trigger download. */
        function exportToExcel(data, filename) { 
            if (data.length === 0) { alert("Không có dữ liệu để xuất!"); return; }
            // Lấy headers (keys của object đầu tiên)
            const headers = Object.keys(data[0]);
            // Format các giá trị để tránh lỗi encoding và dấu phẩy trong nội dung
            const escapeValue = (value) => { 
                if (typeof value === 'number') return value;
                if (value === null || value === undefined) return '';
                let str = String(value).replace(/"/g, '""'); // Escape double quotes
                if (str.includes(',') || str.includes('\n') || str.includes('"')) { 
                    str = `"${str}"`; // Enclose in double quotes if contains comma, newline, or double quote
                } 
                return str; 
            };
            // Tạo hàng header
            let csv = headers.map(h => escapeValue(h)).join(',') + '\n';
            // Thêm các hàng dữ liệu
            data.forEach(row => { 
                const rowData = headers.map(header => escapeValue(row[header])); 
                csv += rowData.join(',') + '\n'; 
            });
            // Tạo Blob và trigger download (UTF-8 with BOM for Excel compatibility)
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); 
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob); 
                link.setAttribute('href', url); 
                link.setAttribute('download', `${filename}.csv`); 
                link.style.visibility = 'hidden';
                document.body.appendChild(link); 
                link.click(); 
                document.body.removeChild(link); 
            } else { 
                alert("Trình duyệt của bạn không hỗ trợ tải file.");
            }
        }

        function exportStudentList(classFilter) {
            let students = db.get('students').sort((a, b) => a.name.localeCompare(b.name, 'vi'));
            let filteredStudents = students;
            if (classFilter !== 'all') {
                filteredStudents = students.filter(s => s.classId === classFilter);
            }
            const exportData = filteredStudents.map((s, i) => ({
                'STT': i + 1,
                'Họ Tên': s.name,
                'SĐT PH': s.phone || 'Chưa có',
                'Lớp': s.classId === '1-1' ? 'Kèm 1-1' : s.classId
            }));
            const filename = classFilter === 'all' ? 'Danh_Sach_Hoc_Sinh_Tat_Ca' : `Danh_Sach_Hoc_Sinh_Lop_${classFilter}`;
            exportToExcel(exportData, filename);
        }

        function exportAttendance(selectedDate, classFilter) {
            const students = db.get('students').sort((a, b) => a.name.localeCompare(b.name, 'vi'));
            const fees = db.get('fees');
            const attendance = db.get('attendance')[selectedDate] || {};
            const maxPaid = CONFIG.SESSIONS_PER_COURSE;

            let filteredStudents = students;
            if (classFilter !== 'all') {
                filteredStudents = students.filter(s => s.classId === classFilter);
            }

            const exportData = filteredStudents.map((s, i) => {
                const att = attendance[s.id];
                const feeData = fees[s.id]?.current || { paid: 0, remaining: 0, debt: 0 };
                const status = att?.status === 'present' ? 'Có Mặt' : 'Vắng';
                
                return {
                    'STT': i + 1,
                    'Họ Tên': s.name,
                    'Lớp': s.classId === '1-1' ? 'Kèm 1-1' : s.classId,
                    'Tình Trạng': status,
                    'Buổi Đã Đóng': feeData.paid,
                    'Buổi Đang Nợ': feeData.debt || 0,
                    'Tình Trạng Học Phí': feeData.paid >= maxPaid ? 'Đủ buổi' : (feeData.paid === 0 && feeData.debt === 0 ? 'Chưa đóng' : 'Thiếu/Nợ buổi'),
                    'Ghi Chú': att?.note || ''
                };
            });
            
            const classPart = classFilter === 'all' ? 'Tat_Ca' : classFilter;
            const filename = `Diem_Danh_${selectedDate}_Lop_${classPart}`;
            exportToExcel(exportData, filename);
        }

        function exportFees(classFilter, searchQuery) {
            const students = db.get('students').sort((a, b) => a.name.localeCompare(b.name, 'vi'));
            const fees = db.get('fees');
            const maxPaid = CONFIG.SESSIONS_PER_COURSE;
            
            let filteredStudents = students;
            if (classFilter !== 'all') {
                filteredStudents = students.filter(s => s.classId === classFilter);
            }
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filteredStudents = filteredStudents.filter(s => 
                    s.name.toLowerCase().includes(query) || s.phone.includes(query) 
                );
            }

            const exportData = filteredStudents.map(s => {
                const data = fees[s.id]?.current || { paid: 0, remaining: 0, debt: 0 };
                const feePerSession = getFeeByClass(s.classId);
                
                // Cần tính lại Tổng Tiền Đã Thu chính xác từ lịch sử giao dịch
                let calculatedRevenue = 0;
                if (fees[s.id] && fees[s.id].history) {
                    fees[s.id].history.forEach(item => {
                        if (item.feeValue > 0 && item.change > 0) { // New paid sessions
                            calculatedRevenue += item.change * item.feeValue;
                        } else if (item.feeValue === 0 && item.change > 0) { // New cash added (remaining_plus)
                            calculatedRevenue += item.change;
                        }
                    });
                }
                
                return {
                    'Họ Tên': s.name,
                    'Loại Lớp': s.classId === '1-1' ? 'Kèm 1-1' : s.classId,
                    'Học Phí/Buổi (VND)': feePerSession,
                    'Buổi Đã Đóng': data.paid,
                    'Buổi Đang Nợ': data.debt || 0,
                    'Tổng Tiền Đã Thu (VND)': calculatedRevenue,
                    'Tiền Dư (VND)': data.remaining,
                    'Tình trạng': data.paid >= maxPaid ? 'Đủ buổi' : (data.paid === 0 && data.debt === 0 ? 'Chưa đóng' : (data.debt > 0 ? 'Đang nợ' : 'Thiếu buổi'))
                };
            });
            const classPart = classFilter === 'all' ? 'Tat_Ca' : classFilter;
            const filename = `Hoc_Phi_Tong_Quan_Lop_${classPart}`;
            exportToExcel(exportData, filename);
        }

        function exportReports() {
            const students = db.get('students');
            const attendance = db.get('attendance');
            
            // Recalculate the report data (same logic as in renderReports)
            const sessionsByClass = {};
            CLASSES.forEach(c => sessionsByClass[c] = { count: 0, revenue: 0 });

            for (const day in attendance) {
                const dailyAtt = attendance[day];
                for (const studentId in dailyAtt) {
                    if (dailyAtt[studentId].status === 'present') {
                        const student = students.find(s => s.id === studentId);
                        if (student) {
                            const fee = getFeeByClass(student.classId);
                            const classId = student.classId;
                            sessionsByClass[classId] = sessionsByClass[classId] || { count: 0, revenue: 0 };
                            sessionsByClass[classId].count++;
                            sessionsByClass[classId].revenue += fee;
                        }
                    }
                }
            }
            
            // Prepare export data
            const exportData = Object.entries(sessionsByClass)
                .sort(([classA], [classB]) => classA.localeCompare(classB))
                .map(([classId, data]) => ({
                    'Lớp': classId === '1-1' ? 'Kèm 1-1' : `Lớp ${classId}`,
                    'Số Buổi Đã Học': data.count,
                    'Doanh Thu Tạm Tính (VND)': data.revenue
                }));
            
            const filename = 'Bao_Cao_Tong_Hop_Buoi_Hoc';
            exportToExcel(exportData, filename);
        }

        function showFeeHistoryModal(studentId, studentName) {
            const fees = db.get('fees');
            const history = fees[studentId]?.history || [];

            const historyRows = history.sort((a, b) => new Date(b.date) - new Date(a.date)).map(item => {
                let changeDisplay;
                if (item.feeValue > 0) {
                    // Giao dịch buổi (paid session)
                    changeDisplay = `${item.change > 0 ? '+' : ''}${item.change} buổi`;
                    if (item.change !== 0) {
                        changeDisplay += ` (${(item.change * item.feeValue).toLocaleString('vi-VN')}₫)`;
                    }
                } else if (item.feeValue === 0) {
                    // Giao dịch tiền (remaining cash)
                    changeDisplay = `${item.change > 0 ? '+' : ''}${item.change.toLocaleString('vi-VN')}₫ (Tiền dư)`;
                } else {
                    changeDisplay = '—';
                }

                return `
                    <tr>
                        <td class="whitespace-nowrap">${app.getFormattedDate(item.date)}</td>
                        <td class="${item.change > 0 ? 'text-accent-green' : (item.change < 0 ? 'text-red-500' : 'text-gray-500')} font-bold min-w-[150px]">${changeDisplay}</td>
                        <td class="text-sm text-gray-700">${item.reason || 'Cập nhật thủ công'}</td>
                        <td class="text-center">${item.paidAfter}</td>
                        <td class="text-center">${item.debtAfter}</td>
                        <td class="text-right">${item.remainingAfter.toLocaleString('vi-VN')}₫</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('modalContainer').innerHTML = `
                <div class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 flex items-center justify-center z-[1001]" onclick="this.remove()">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-4xl transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
                        <h3 class="text-2xl font-bold text-primary-blue mb-6 border-b pb-2"><i class="fas fa-history mr-2"></i> Lịch Sử Giao Dịch: ${studentName}</h3>
                        
                        <div class="overflow-x-auto h-96 overflow-y-auto">
                            <table class="responsive-table sticky-header">
                                <thead>
                                    <tr>
                                        <th>Ngày</th>
                                        <th>Giao Dịch</th>
                                        <th>Lý Do</th>
                                        <th class="text-center">Buổi Sau</th>
                                        <th class="text-center">Nợ Sau</th>
                                        <th class="text-right">Tiền Dư Sau</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${historyRows || '<tr><td colspan="6" class="text-center py-4 text-gray-500">Chưa có giao dịch nào.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="w-full btn-primary !bg-secondary-orange mt-6 !py-3">Đóng</button>
                    </div>
                </div>`;
        }


        // Khởi động
        app.init();
    </script>
</body>
</html>